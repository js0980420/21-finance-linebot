import{D as z,l as b,X as L,r as _,b as w,Y as $,p as C,n as D}from"#entry";const I=()=>{const r=b(),p=z(),x=M(),u=(()=>{if(window.location.origin==="https://crm-nuxt-demo.pages.dev"||r.public.apiBaseUrl==="/mock-api")return"/mock-api";if(r.public.apiBaseUrl)return r.public.apiBaseUrl;throw new Error("API base URL is not configured in runtimeConfig.public.apiBaseUrl")})(),m=u==="/mock-api",f=async(n,s,l=null,A={})=>{if(m){if(console.warn(`[Mock API] Intercepted ${n} request to ${s}. Returning mock data.`),s==="/auth/me")return{data:{success:!0,data:{user:{id:1,name:"Admin User (Mock)",email:"admin@finance-crm.com",roles:[{name:"admin"}],avatar:"https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff"},token:"mock-token-for-admin"}},error:null};if(s==="/auth/login")return{data:{success:!0,access_token:"mock-jwt-token-for-manual-login-"+Date.now(),user:{id:2,name:"Demo User (Mock)",email:"demo@finance-crm.com",roles:[{name:"staff"}],avatar:"https://ui-avatars.com/api/?name=Demo&background=0ea5e9&color=fff"}},error:null};if(s.includes("/contact-schedules")){if(s.includes("/overdue/list")||s.includes("/reminders/list")||s.includes("/today/list"))return{data:{success:!0,data:[]},error:null};if(s.includes("/calendar/data"))return{data:{success:!0,data:{}},error:null}}return s==="/customers"?{data:{success:!0,data:{data:[{id:1,name:"Mock Customer 1",phone:"09xx-xxxxxx"},{id:2,name:"Mock Customer 2",phone:"09xx-xxxxxx"}]}},error:null}:s.startsWith("/leads")?{data:{success:!0,data:{data:[],total:0,per_page:15,current_page:1}},error:null}:{data:{success:!0,message:"Mock API 請求成功",data:{},items:[],meta:{total:0,per_page:15,currentPage:1,lastPage:1}},error:null}}let h=null;r.public.skipAuth?h="mock-token-for-skip-auth":h=x.token;const g={method:n.toUpperCase(),baseURL:u,headers:{"Content-Type":"application/json",Accept:"application/json",...h?{Authorization:`Bearer ${h}`}:{},...A.headers},...A};try{if(l&&["POST","PUT","PATCH"].includes(g.method))g.body=JSON.stringify(l);else if(l&&g.method==="GET"){const e=new URLSearchParams(l);s+=`?${e.toString()}`}const t=u?s:`/api${s}`;return{data:await $fetch(t,g),error:null}}catch(t){const S=u?`${u}${s}`:`/api${s}`,i=["/contact-schedules/reminders/list","/contact-schedules/overdue/list","/contact-schedules/today/list"].some(a=>s.includes(a))&&t.status===401;if(i||console.error(`API Request Error [${n} ${s}]:`,{status:t.status,message:t.message,data:t.data,baseURL:u||"(using proxy)",fullURL:S,headers:g.headers,credentials:g.credentials}),t.status===401){if(r.public.skipAuth)return console.log("跳過認證模式下忽略 401 錯誤，返回模擬成功回應"),{data:{message:"模擬回應 (跳過認證模式)",user:null,mock_response:!0},error:null};i||(console.warn("Authentication failed - clearing session and redirecting to login"),sessionStorage.removeItem("user-profile"),localStorage.removeItem("auth-token"),localStorage.removeItem("admin-template-user"),document.cookie.includes("auth-token")?console.warn("Auth token cookie still exists but API returned 401"):console.warn("No auth token cookie found"),await p.push("/auth/login"))}return{data:null,error:{status:t.status,message:t.data?.message||t.message||"請求失敗",error:t.data?.error||t.message||"請求失敗",errors:t.data?.errors||null,debug_info:t.data?.debug_info||null,debug:null}}}};return{apiRequest:f,get:async(n,s={},l={})=>await f("GET",n,s,l),post:async(n,s={},l={})=>await f("POST",n,s,l),put:async(n,s={},l={})=>await f("PUT",n,s,l),del:async(n,s={})=>await f("DELETE",n,null,s),patch:async(n,s={},l={})=>await f("PATCH",n,s,l)}},M=L("auth",()=>{const r=_(null),p=w(()=>!!r.value&&!!r.value.token),x=w(()=>r.value?.token||null),d=_(!1),u=_(!1),m=_(null),f=w(()=>r.value?.role===k.EXECUTIVE),E=w(()=>r.value?.role===k.ADMIN),P=w(()=>r.value?.role===k.MANAGER),T=w(()=>r.value?.role===k.STAFF),U=e=>r.value?r.value.role==="admin"||r.value.role==="executive"||r.value.permissions?.includes("all_access")?!0:r.value.permissions?.includes(e):!1,k={ADMIN:"admin",EXECUTIVE:"executive",MANAGER:"manager",STAFF:"staff"},n=async e=>{try{const{post:i}=I();console.log("Login credentials:",{username:e.username,password:e.password,passwordLength:e.password?.length,passwordType:typeof e.password});const{data:a,error:c}=await i("/auth/login",{username:e.username,password:e.password});if(c)throw new Error(c.message||"登入失敗");if(a.access_token&&a.user){console.log("Backend response:",{access_token:!!a.access_token,user:a.user,roles:a.user.roles,rolesType:typeof a.user.roles,rolesLength:a.user.roles?.length,firstRole:a.user.roles?.[0]});const o={...a.user,token:a.access_token,role:Array.isArray(a.user.roles)?a.user.roles[0]:a.user.roles&&a.user.roles[0]||null};return console.log("設定的用戶資料:",o),r.value=o,await C(),console.log("設定後的 user.value:",r.value),console.log("設定後的 isLoggedIn:",p.value),sessionStorage.setItem("user-profile",JSON.stringify({id:o.id,username:o.username,email:o.email,name:o.name,roles:o.roles,permissions:o.permissions,is_admin:o.is_admin,is_manager:o.is_manager,token:o.token})),console.log("登入成功，使用 JWT Token + SessionStorage"),await new Promise(y=>setTimeout(y,50)),{success:!0,user:o}}else throw new Error("登入回應格式錯誤")}catch(i){throw console.error("Login failed:",i),new Error(i.message||"登入失敗，請檢查您的帳號密碼")}},s=async e=>{try{const{post:i}=I(),{data:a,error:c}=await i("/auth/register",e);if(c)throw new Error(c.message||"註冊失敗，請稍後再試");return{success:!0,message:a.message||"註冊成功，請使用您的帳號密碼登入"}}catch(i){throw console.error("Registration failed:",i),new Error(i.message||"註冊失敗，請稍後再試")}},l=async()=>{try{const{post:e}=I();await e("/auth/logout")}catch(e){console.error("Logout API error:",e)}r.value=null,sessionStorage.removeItem("user-profile"),localStorage.removeItem("admin-template-user"),localStorage.removeItem("auth-token"),console.log("已登出，清除會話資料"),D("/auth/login")},A=e=>{r.value=e},h=()=>({id:1,username:"admin",email:"admin@finance.local",name:"System Administrator (開發模式)",role:"admin",roles:["admin"],permissions:["all_access"],is_admin:!0,is_manager:!0,token:"mock_jwt_token_for_development_"+Date.now()}),g=()=>{console.log("初始化跳過認證模式 - 建立模擬 admin 用戶"),d.value=!0;const e=h();return r.value=e,sessionStorage.setItem("user-profile",JSON.stringify({id:e.id,username:e.username,email:e.email,name:e.name,roles:e.roles,permissions:e.permissions,is_admin:e.is_admin,is_manager:e.is_manager,token:e.token})),console.log("模擬 admin 用戶已建立:",e.username),d.value=!1,u.value=!0,m.value=null,!0},t=async(e=!1)=>{if(b().public.skipAuth)return console.log("跳過認證模式已啟用"),!r.value||e?g():p.value;if(u.value&&!e)return console.log("Auth already initialized, skipping"),p.value;if(d.value&&m.value&&!e){console.log("Auth initialization in progress, waiting for existing promise");try{return await m.value}catch(c){return console.error("Failed to wait for existing initialization:",c),!1}}d.value=!0;const a=(async()=>{try{console.log("Starting auth initialization...");const c=sessionStorage.getItem("user-profile");if(c)try{const o=JSON.parse(c);if(!o.token)return console.log("No JWT token found in stored profile"),sessionStorage.removeItem("user-profile"),r.value=null,!1;try{const{get:y}=I(),{data:v,error:R}=await y("/auth/me");return!R&&v?.user?(r.value={...v.user,token:o.token,role:Array.isArray(v.user.roles)?v.user.roles[0]:v.user.roles&&v.user.roles[0]||null},console.log("已恢復登入狀態:",v.user.username),!0):(console.log("JWT token is invalid"),sessionStorage.removeItem("user-profile"),r.value=null,!1)}catch(y){return console.error("API 驗證失敗:",y),r.value={...o,role:Array.isArray(o.roles)?o.roles[0]:o.roles&&o.roles[0]||null,_unverified:!0},console.log("API 暫時無法連線，保留登入狀態但標記為未驗證"),!0}}catch(o){return console.error("解析用戶資料失敗:",o),sessionStorage.removeItem("user-profile"),r.value=null,!1}else return r.value=null,!1}catch(c){return console.error("初始化認證失敗:",c),r.value=null,!1}finally{(localStorage.getItem("admin-template-user")||localStorage.getItem("auth-token"))&&(localStorage.removeItem("admin-template-user"),localStorage.removeItem("auth-token"),console.log("已清除舊的 localStorage 資料")),d.value=!1,u.value=!0,m.value=null,console.log("Auth initialization completed")}})();return m.value=a,await a},S=async()=>{if(u.value)return p.value;if(d.value&&m.value)try{return await m.value}catch(e){return console.error("Failed to wait for initialization:",e),!1}return await t()};return{user:$(r),token:x,isLoggedIn:p,isAdmin:E,isExecutive:f,isManager:P,isStaff:T,roles:k,_isInitialized:u,_isInitializing:d,login:n,register:s,logout:l,setUser:A,initializeAuth:t,waitForInitialization:S,hasPermission:U,createMockAdminUser:h,initializeSkipAuthMode:g}}),O=Object.freeze(Object.defineProperty({__proto__:null,useAuthStore:M},Symbol.toStringTag,{value:"Module"}));export{I as a,O as b,M as u};
