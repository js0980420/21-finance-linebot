import{_ as ke}from"./0es6LyBp.js";import{r as d,b as S,H as Ce,y as Le,i as Se,C as Ae,u as Te,c as o,a as t,e as v,x as f,j as je,d as l,k as m,f as $,t as r,g as w,v as F,p as De,o as n,F as A,q as T,A as J,I as K}from"#entry";import{_ as Ue,r as Ee}from"./CRGlAI26.js";import{u as Ne,m as Pe}from"./7WFD-W98.js";import{u as $e}from"./CaSEveCJ.js";import{u as Fe}from"./l19cjJOa.js";import{u as Ve}from"./CuXVLCuF.js";import{u as Ge}from"./DdqGq6Yh.js";import{u as Ie,a as ze}from"./DgLT0ASK.js";import{u as Me}from"./BtlpaPqX.js";import{u as Be}from"./DzJdZt_Q.js";import{r as Re}from"./UqRq4KLf.js";import{r as We}from"./BKE9UY2T.js";import{r as Oe}from"./DdngC8ig.js";import"./B5My0XuL.js";import"./CKtbBPOe.js";import"./DQZituR6.js";const X={items:[]},qe={data:[{id:1,name:"網站G1",domain:"g1.example.com"},{id:2,name:"網站G2",domain:"g2.example.com"},{id:3,name:"網站G3",domain:"g3.example.com"},{id:4,name:"網站G4",domain:"g4.example.com"},{id:5,name:"網站G5",domain:"g5.example.com"},{id:6,name:"網站G6",domain:"g6.example.com"},{id:7,name:"網站G7",domain:"g7.example.com"},{id:8,name:"網站G8",domain:"g8.example.com"},{id:9,name:"網站G9",domain:"g9.example.com"},{id:10,name:"網站G10",domain:"g10.example.com"}],error:null},He={class:"space-y-6"},Qe={class:"flex items-center justify-between"},Ye=["value"],Je=["value"],Ke=["value","onChange"],Xe=["value"],Ze=["value","onChange"],et={class:"text-sm font-medium text-gray-900"},tt={class:"text-sm text-gray-900"},st={class:"text-sm text-gray-900"},at={class:"text-sm text-gray-900"},lt={class:"text-xs text-gray-500"},ot={class:"flex items-center space-x-2"},nt={class:"text-sm text-gray-900"},rt={key:0,class:"flex items-center space-x-2"},it=["src","alt"],ut={key:1,class:"w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white text-xs"},dt={class:"flex-1 min-w-0"},ct={class:"flex items-center space-x-1"},mt={class:"text-xs font-medium text-gray-900 truncate"},gt={key:1,class:"flex items-center space-x-2"},pt={class:"text-xs text-gray-900"},xt={key:2,class:"text-xs text-gray-400"},ft={key:0,class:"space-y-1"},yt={class:"text-gray-500"},bt={class:"text-gray-900 ml-1"},vt={key:0,class:"text-xs text-gray-400"},ht={key:1,class:"text-xs text-gray-400"},_t={class:"flex items-center space-x-2 justify-end"},wt=["onClick"],kt=["onClick"],Ct={class:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"},Lt={key:0,class:"space-y-4"},St={class:"grid grid-cols-2 gap-4"},At={class:"text-gray-900"},Tt={class:"text-gray-900"},jt={class:"text-gray-900"},Dt={class:"text-gray-900"},Ut={class:"text-gray-900"},Et={class:"text-gray-900"},Nt={key:0},Pt={class:"text-gray-900 whitespace-pre-wrap"},$t={class:"bg-white rounded-lg p-6 w-full max-w-lg"},Ft={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},Vt={class:"md:col-span-2"},ss={__name:"tracking",setup(Gt){const V=Ie(),{success:G,error:h}=Me(),{CASE_STATUS_OPTIONS:Z,loadCasesByStatus:ee,addCase:te,updateCaseStatus:se,updateBusinessLevel:ae,generateCaseForCurrentPage:le}=Ge(),{convertToCase:oe}=Fe();Ne(),Be(),ze();const y=d(""),g=d("all"),x=d("all"),j=d(!1),D=d(null),U=d([]),I=d([]),z=d([]),M=d([]),E=d(!1),k=d(!1),c=d(null),C=d(null),B=d(!1),_=d(1),N=d(10);S(()=>Math.ceil(W.value.length/N.value));const R=d([]),p=Ce({loan_amount:null,loan_type:"",notes:""}),ne=S(()=>[{key:"case_status",title:"案件狀態",sortable:!0,width:"160px"},{key:"business_level",title:"業務等級",sortable:!0,width:"100px"},{key:"case_number",title:"案件編號",sortable:!0,width:"140px",hidden:!0},{key:"datetime",title:"時間",sortable:!0,width:"140px"},{key:"assignee",title:"承辦業務",sortable:!0,width:"100px"},{key:"channel",title:"來源管道",sortable:!0,width:"100px"},{key:"customer_name",title:"姓名",sortable:!0,width:"120px"},{key:"line_info",title:"LINE資訊",sortable:!1,width:"160px"},{key:"purpose",title:"諮詢項目",sortable:!1,width:"120px"},{key:"website_name",title:"網站",sortable:!1,width:"140px"},{key:"contact_info",title:"聯絡資訊",sortable:!1,width:"160px",hidden:!0},{key:"location",title:"地區/地址",sortable:!1,width:"160px",hidden:!0},{key:"amount",title:"需求金額",sortable:!1,width:"120px",hidden:!0},{key:"custom_fields",title:"自定義欄位",sortable:!1,width:"140px",hidden:!0},{key:"actions",title:"操作",sortable:!1,width:"160px"}]),W=S(()=>{let s=U.value;if(y.value&&y.value.length>=2){const e=y.value.toLowerCase();s=s.filter(u=>u.email?.toLowerCase().includes(e)||u.line_id?.toLowerCase().includes(e)||u.payload?.頁面_URL?.toLowerCase().includes(e)||u.source?.toLowerCase().includes(e)||u.assignee?.name?.toLowerCase().includes(e)||u.customer_name?.toLowerCase().includes(e))}return g.value&&g.value!=="all"&&(g.value==="null"?s=s.filter(e=>!e.assigned_to):s=s.filter(e=>e.assigned_to===parseInt(g.value))),x.value&&x.value!=="all"&&(s=s.filter(e=>ve(e.payload?.頁面_URL||e.source)===x.value)),s}),L=S(()=>R.value.filter(s=>s.is_visible)),b=async()=>{j.value=!0,D.value=null;try{const s=await ee("tracking");U.value=s||[]}catch(s){D.value="載入追蹤案件數據失敗",console.error("Load tracking cases error:",s)}finally{j.value=!1}},re=async()=>{try{const{users:s,success:e}=Pe;e&&Array.isArray(s)&&(I.value=s)}catch(s){console.warn("Load users failed:",s)}},ie=async()=>{R.value=[]},ue=async()=>{try{const{data:s,error:e}=qe;!e&&Array.isArray(s)?(z.value=s,M.value=s.map(u=>({value:u.domain,label:u.name,website:u}))):console.warn("Failed to load websites from management system:",e)}catch(s){console.warn("Load websites failed:",s)}},de=s=>{y.value=s,_.value=1},ce=s=>{_.value=s},me=s=>{N.value=s,_.value=1};let P;Le([y,g,x],()=>{clearTimeout(P),P=setTimeout(()=>{_.value=1},300)});const ge=s=>{c.value=s,E.value=!0},O=()=>{E.value=!1,c.value=null},pe=s=>{if(!s.customer_id){h("此案件尚未綁定客戶，請先建立/綁定客戶後再送件");return}C.value=s,Object.assign(p,{loan_amount:null,loan_type:"",notes:""}),k.value=!0},q=()=>{k.value=!1,C.value=null},xe=async()=>{if(C.value){B.value=!0;try{const{error:s}=await oe(C.value.id,p);s?h(s?.message||"轉換失敗"):(k.value=!1,await b(),G("案件轉換成功"))}catch(s){h("系統錯誤，請稍後再試"),console.error("Convert case error:",s)}finally{B.value=!1}}},fe=async(s,e)=>{(await se(s.id,e,!0)).success&&(e!=="tracking"?await b():s.case_status=e)},ye=async(s,e)=>{(await ae(s.id,e)).success&&(s.business_level=e)},be=async()=>{try{const s=le("wp_form"),e=await te(s);e.success?(await b(),await De(),console.log("追蹤案件新增完成，當前列表數量:",U.value.length),G(`新增追蹤案件 #${e.data.id} 成功！`)):h(e.error?.message||"新增案件失敗")}catch(s){h("新增案件時發生錯誤"),console.error("Add mock case error:",s)}},ve=s=>{try{return new URL(s).hostname}catch{return s||""}},he=s=>{const e=new Date(s.created_at),u=e.getFullYear().toString().slice(-2),a=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),we=String(s.id).padStart(3,"0");return`CASE${u}${a}${i}${we}`},{getWebsiteInfo:H}=Ve(z),Q=s=>new Date(s).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}),Y=s=>new Date(s).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}),_e=(s,e)=>e.type==="multiselect"?Array.isArray(s)?s.join(", "):s||"-":e.type==="boolean"?s?"是":"否":s??"-";return Se(async()=>{const s=$e();s.leads.length===0&&X.items.length>0&&X.items.forEach(e=>s.addLead(e)),await Promise.all([re(),b(),ie(),ue()])}),Ae(()=>{clearTimeout(P)}),Te({title:"追蹤管理 - 貸款案件管理系統"}),(s,e)=>{const u=ke;return n(),o("div",He,[t("div",Qe,[e[7]||(e[7]=t("div",null,[t("h1",{class:"text-3xl font-bold text-gray-900"},"追蹤管理"),t("p",{class:"text-gray-600 mt-2"},"管理客戶追蹤狀態和排程")],-1)),t("button",{onClick:be,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"},[v(l(Re),{class:"-ml-1 mr-2 h-5 w-5","aria-hidden":"true"}),e[6]||(e[6]=je(" 新增案件 ",-1))])]),v(Ue,{title:"追蹤案件列表",columns:l(ne),data:l(W),loading:l(j),error:l(D),"search-query":l(y),"search-placeholder":"搜尋姓名/手機/Email/LINE/網站... (至少2個字符)","show-search-icon":!1,"current-page":l(_),"items-per-page":l(N),"loading-text":"載入中...","empty-text":"沒有追蹤中的案件",onSearch:de,onRefresh:b,onRetry:b,onPageChange:ce,onPageSizeChange:me},{filters:m(()=>[l(V).hasPermission&&l(V).hasPermission("customer_management")?w((n(),o("select",{key:0,"onUpdate:modelValue":e[0]||(e[0]=a=>J(g)?g.value=a:null),class:"px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500"},[e[8]||(e[8]=t("option",{value:"all"},"全部承辦",-1)),e[9]||(e[9]=t("option",{value:"null"},"未指派",-1)),(n(!0),o(A,null,T(l(I),a=>(n(),o("option",{key:a.id,value:a.id},r(a.name),9,Ye))),128))],512)),[[K,l(g)]]):f("",!0),w(t("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>J(x)?x.value=a:null),class:"px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500"},[e[10]||(e[10]=t("option",{value:"all"},"全部網站",-1)),(n(!0),o(A,null,T(l(M),a=>(n(),o("option",{key:a.value,value:a.value},r(a.label),9,Je))),128))],512),[[K,l(x)]])]),"cell-case_status":m(({item:a})=>[t("select",{value:a.case_status||"tracking",onChange:i=>fe(a,i.target.value),class:"w-full px-1 py-0.5 text-xs border border-gray-300 rounded bg-white text-gray-900 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"},[(n(!0),o(A,null,T(l(Z),i=>(n(),o("option",{key:i.value,value:i.value},r(i.label),9,Xe))),128))],40,Ke)]),"cell-business_level":m(({item:a})=>[t("select",{value:a.business_level||"A",onChange:i=>ye(a,i.target.value),class:"w-full px-1 py-0.5 text-xs border border-gray-300 rounded bg-white text-gray-900 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"},[...e[11]||(e[11]=[t("option",{value:"A"},"A級",-1),t("option",{value:"B"},"B級",-1),t("option",{value:"C"},"C級",-1)])],40,Ze)]),"cell-case_number":m(({item:a})=>[t("div",et,r(he(a)),1)]),"cell-website_name":m(({item:a})=>[t("span",tt,r(l(H)(a.payload?.頁面_URL||a.source).name),1)]),"cell-channel":m(({item:a})=>[t("span",st,r(a.channel==="wp_form"?"網站表單":a.channel==="lineoa"?"官方賴":a.channel==="email"?"Email":a.channel==="phone"?"電話":a.channel||"-"),1)]),"cell-datetime":m(({item:a})=>[t("div",null,[t("div",at,r(Q(a.created_at)),1),t("div",lt,r(Y(a.created_at)),1)])]),"cell-assignee":m(({item:a})=>[t("div",ot,[t("span",nt,r(a.assignee?.name||"未指派"),1)])]),"cell-line_info":m(({item:a})=>[a.line_user_info&&a.is_line_user_id?(n(),o("div",rt,[a.line_user_info.picture_url?(n(),o("img",{key:0,src:a.line_user_info.picture_url,alt:a.line_user_info.display_name||"LINE用戶",class:"w-6 h-6 rounded-full object-cover",onError:e[2]||(e[2]=i=>i.target.style.display="none")},null,40,it)):(n(),o("div",ut," L ")),t("div",dt,[t("div",ct,[t("span",mt,r(a.line_user_info.display_name||"未設定名稱"),1)])])])):a.line_id&&!a.is_line_user_id?(n(),o("div",gt,[e[12]||(e[12]=t("div",{class:"w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center text-white text-xs"}," @ ",-1)),t("span",pt,r(a.line_id),1)])):(n(),o("div",xt," 未綁定 "))]),"cell-custom_fields":m(({item:a})=>[l(L).length>0?(n(),o("div",ft,[(n(!0),o(A,null,T(l(L).slice(0,2),i=>(n(),o("div",{key:i.id,class:"text-xs"},[t("span",yt,r(i.label)+":",1),t("span",bt,r(_e(a.payload?.[i.key],i)),1)]))),128)),l(L).length>2?(n(),o("div",vt," +"+r(l(L).length-2)+" 個欄位 ",1)):f("",!0)])):(n(),o("span",ht,"無自定義欄位"))]),"cell-actions":m(({item:a})=>[t("div",_t,[t("button",{onClick:i=>ge(a),class:"group relative inline-flex items-center justify-center p-2 text-blue-600 hover:text-white hover:bg-blue-600 rounded-lg transition-all duration-200",title:"查看詳情"},[v(l(We),{class:"w-4 h-4"}),e[13]||(e[13]=t("div",{class:"absolute bottom-full mb-2 hidden group-hover:block px-2 py-1 text-xs text-white bg-gray-900 rounded whitespace-nowrap z-10"}," 查看詳情 ",-1))],8,wt),v(u,{to:`/sales/customers/edit/${a.id}`,class:"group relative inline-flex items-center justify-center p-2 text-gray-600 hover:text-white hover:bg-gray-600 rounded-lg transition-all duration-200",title:"編輯"},{default:m(()=>[v(l(Ee),{class:"w-4 h-4"}),e[14]||(e[14]=t("div",{class:"absolute bottom-full mb-2 hidden group-hover:block px-2 py-1 text-xs text-white bg-gray-900 rounded whitespace-nowrap z-10"}," 編輯 ",-1))]),_:1},8,["to"]),a.customer_id?(n(),o("button",{key:0,onClick:i=>pe(a),class:"group relative inline-flex items-center justify-center p-2 text-purple-600 hover:text-white hover:bg-purple-600 rounded-lg transition-all duration-200",title:"轉送件"},[v(l(Oe),{class:"w-4 h-4"}),e[15]||(e[15]=t("div",{class:"absolute bottom-full mb-2 hidden group-hover:block px-2 py-1 text-xs text-white bg-gray-900 rounded whitespace-nowrap z-10"}," 轉送件 ",-1))],8,kt)):f("",!0)])]),_:1},8,["columns","data","loading","error","search-query","current-page","items-per-page"]),l(E)?(n(),o("div",{key:0,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 mt-0",onClick:$(O,["self"])},[t("div",Ct,[t("div",{class:"flex justify-between items-center mb-4"},[e[16]||(e[16]=t("h3",{class:"text-lg font-semibold text-gray-900"},"案件詳情",-1)),t("button",{onClick:O,class:"text-gray-400 hover:text-gray-600"}," ✕ ")]),l(c)?(n(),o("div",Lt,[t("div",St,[t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-gray-700"},"網站",-1)),t("p",At,r(l(H)(l(c).payload?.頁面_URL||l(c).source).name),1)]),t("div",null,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-gray-700"},"來源管道",-1)),t("p",Tt,r(l(c).channel||"wp_form"),1)]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-gray-700"},"時間",-1)),t("p",jt,r(Q(l(c).created_at))+" "+r(Y(l(c).created_at)),1)]),t("div",null,[e[20]||(e[20]=t("label",{class:"block text-sm font-medium text-gray-700"},"承辦業務",-1)),t("p",Dt,r(l(c).assignee?.name||"未指派"),1)]),t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-medium text-gray-700"},"Email",-1)),t("p",Ut,r(l(c).email||"未提供"),1)]),t("div",null,[e[22]||(e[22]=t("label",{class:"block text-sm font-medium text-gray-700"},"LINE ID",-1)),t("p",Et,r(l(c).line_id||"未提供"),1)])]),l(c).notes?(n(),o("div",Nt,[e[23]||(e[23]=t("label",{class:"block text-sm font-medium text-gray-700"},"備註",-1)),t("p",Pt,r(l(c).notes),1)])):f("",!0)])):f("",!0)])])):f("",!0),l(k)?(n(),o("div",{key:1,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 mt-0",onClick:$(q,["self"])},[t("div",$t,[e[28]||(e[28]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"送件（建立案件）",-1)),t("form",{onSubmit:$(xe,["prevent"]),class:"space-y-3"},[t("div",Ft,[t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},"貸款金額",-1)),w(t("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>l(p).loan_amount=a),required:"",type:"number",min:"0",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[F,l(p).loan_amount,void 0,{number:!0}]])]),t("div",null,[e[25]||(e[25]=t("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},"貸款類型",-1)),w(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>l(p).loan_type=a),class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[F,l(p).loan_type]])]),t("div",Vt,[e[26]||(e[26]=t("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},"備註",-1)),w(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=a=>l(p).notes=a),rows:"2",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[F,l(p).notes]])])]),t("div",{class:"flex justify-end space-x-3 pt-2"},[t("button",{type:"button",class:"px-4 py-2 border border-gray-300 rounded-lg",onClick:q},"取消"),e[27]||(e[27]=t("button",{type:"submit",class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"},"送件",-1))])],32)])])):f("",!0)])}}};export{ss as default};
