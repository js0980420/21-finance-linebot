import{l as U,_ as ue,r as i,b as B,H as de,i as me,u as ge,c as m,a as e,e as D,x as $,k as c,d as s,f as E,t as a,g as d,j as y,v,I as O,F as J,q as K,G as pe,o as g,A as be}from"#entry";import{_ as fe,r as xe}from"./CRGlAI26.js";import{u as T}from"./CaSEveCJ.js";import{u as ye}from"./DgLT0ASK.js";import{u as ve}from"./BtlpaPqX.js";import{u as _e}from"./7WFD-W98.js";import{r as ke}from"./BKE9UY2T.js";import{r as we}from"./c8JhvyFk.js";import{r as he}from"./UqRq4KLf.js";import"./B5My0XuL.js";import"./CKtbBPOe.js";function Se(){return{list:()=>{if(console.log("Listing tracking records from mock store"),U().public.apiBaseUrl==="/mock-api"){const p=T();return Promise.resolve({items:p.trackingRecords,success:!0})}return Promise.resolve({items:[],success:!0})},create:u=>(console.log("Creating tracking record:",u),U().public.apiBaseUrl==="/mock-api"?{error:!1,message:"Success",data:T().addTrackingRecord(u)}:{error:!1,message:"Success"}),update:(u,p)=>{if(console.log(`Updating tracking record ${u}:`,p),U().public.apiBaseUrl==="/mock-api"){const w=T().updateTrackingRecord(parseInt(u),p);return{error:!w,message:w?"Success":"Not found",data:w}}return{error:!1,message:"Success"}},remove:u=>{if(console.log(`Removing tracking record ${u}`),U().public.apiBaseUrl==="/mock-api"){const b=T().removeTrackingRecord(parseInt(u));return{error:!b,message:b?"Success":"Not found",data:b}}return{error:!1,message:"Success"}}}}const Re={class:"space-y-6"},Ce=["value"],De={class:"text-sm font-medium text-gray-900"},Ue={class:"text-sm font-medium text-gray-900"},Te={class:"text-sm text-gray-900"},Ve={class:"text-xs text-gray-500"},je={class:"text-sm text-gray-900"},Le={class:"text-sm text-gray-900"},Pe={class:"text-sm text-gray-900 truncate max-w-[200px]"},Me={class:"text-sm text-gray-900"},$e={class:"text-sm text-gray-900"},qe={class:"text-sm text-gray-900 truncate max-w-[200px]"},Ie={class:"flex items-center space-x-2 justify-end"},Ne=["onClick"],ze=["onClick"],Ae=["onClick"],Be={class:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"},Ee={class:"text-lg font-semibold text-gray-900 mb-4"},Oe=["value"],Fe={class:"flex justify-end space-x-3 pt-4"},He=["disabled"],We={class:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"},Ge={key:0,class:"space-y-4"},Qe={class:"text-gray-900"},Je={class:"text-gray-900"},Ke={class:"text-gray-900"},Xe={class:"text-gray-900"},Ye={class:"text-gray-900"},Ze={class:"text-gray-900 whitespace-pre-wrap"},et={class:"text-gray-900"},tt={class:"text-gray-900"},ot={class:"text-gray-900 whitespace-pre-wrap"},st={__name:"tracking-records",setup(X){const V=ye(),{success:q,error:k,confirm:u}=ve(),{list:p,create:j,update:b,remove:w}=Se(),{getUsers:Y}=_e(),h=i(""),_=i("all"),L=i(!1),I=i(null),N=i([]),S=i([]),R=i(!1),z=i(!1),f=i(null),l=i(null),P=i(!1),M=i(1),A=i(10);B(()=>Math.ceil(F.value.length/A.value));const n=de({customer_name:"",tracking_person_id:null,contact_time:"",service_stage:"",opportunity_order:"",maintenance_progress:"",opportunity_status:"",contact_method:"",conversation_record:""}),Z=B(()=>[{key:"customer_name",title:"客戶姓名",sortable:!0,width:"120px"},{key:"tracking_person",title:"記錄人員",sortable:!0,width:"100px"},{key:"contact_time",title:"聯繫時間",sortable:!0,width:"160px"},{key:"service_stage",title:"服務階段",sortable:!0,width:"120px"},{key:"opportunity_order",title:"商機單",sortable:!1,width:"120px"},{key:"maintenance_progress",title:"維護進度",sortable:!1,width:"200px"},{key:"opportunity_status",title:"商機狀態",sortable:!0,width:"120px"},{key:"contact_method",title:"聯絡方式",sortable:!0,width:"100px"},{key:"conversation_record",title:"對話紀錄",sortable:!1,width:"250px"},{key:"actions",title:"操作",sortable:!1,width:"160px"}]),F=B(()=>{let r=N.value;if(h.value&&h.value.length>=2){const t=h.value.toLowerCase();r=r.filter(o=>o.customer_name?.toLowerCase().includes(t)||o.tracking_person_name?.toLowerCase().includes(t)||o.conversation_record?.toLowerCase().includes(t))}return _.value&&_.value!=="all"&&(r=r.filter(t=>t.tracking_person_id===parseInt(_.value))),r}),C=async()=>{L.value=!0,I.value=null;try{if(U().public.apiBaseUrl==="/mock-api"){const o=T();N.value=o.trackingRecords.map(x=>({...x,tracking_person_name:S.value.find(ce=>ce.id===x.tracking_person_id)?.name||"未知"})),L.value=!1;return}const t=await p();t.success&&Array.isArray(t.items)&&(N.value=t.items.map(o=>({...o,tracking_person_name:S.value.find(x=>x.id===o.tracking_person_id)?.name||"未知"})))}catch(r){I.value="載入追蹤記錄失敗",console.error("Load tracking records error:",r)}finally{L.value=!1}},ee=async()=>{try{const{success:r,users:t}=await Y({per_page:250});r&&Array.isArray(t)&&(S.value=t)}catch(r){console.warn("Load users failed:",r)}},te=r=>{h.value=r,M.value=1},oe=r=>{M.value=r},se=r=>{A.value=r,M.value=1},re=()=>{f.value=null,Object.assign(n,{customer_name:"",tracking_person_id:V.user?.id||null,contact_time:new Date().toISOString().slice(0,16),service_stage:"",opportunity_order:"",maintenance_progress:"",opportunity_status:"",contact_method:"",conversation_record:""}),R.value=!0},ae=r=>{f.value=r.id,Object.assign(n,{customer_name:r.customer_name,tracking_person_id:r.tracking_person_id,contact_time:r.contact_time?new Date(r.contact_time).toISOString().slice(0,16):"",service_stage:r.service_stage,opportunity_order:r.opportunity_order,maintenance_progress:r.maintenance_progress,opportunity_status:r.opportunity_status,contact_method:r.contact_method,conversation_record:r.conversation_record}),R.value=!0},H=()=>{R.value=!1,f.value=null},ne=async()=>{P.value=!0;try{let r;f.value?r=await b(f.value,n):r=await j(n),r.error?k(r.error?.message||"操作失敗"):(R.value=!1,await C(),q(f.value?"追蹤記錄更新成功":"追蹤記錄新增成功"))}catch(r){k("系統錯誤，請稍後再試"),console.error("Save tracking record error:",r)}finally{P.value=!1}},le=async r=>{if(await u(`確定刪除客戶 ${r.customer_name} 的追蹤記錄嗎？`))try{const{error:o}=await w(r.id);o?k(o?.message||"刪除失敗"):(await C(),q(`客戶 ${r.customer_name} 的追蹤記錄已刪除`))}catch(o){k("系統錯誤，請稍後再試"),console.error("Delete tracking record error:",o)}},ie=r=>{l.value=r,z.value=!0},W=()=>{z.value=!1,l.value=null},G=r=>new Date(r).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}),Q=r=>new Date(r).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"});return me(async()=>{await Promise.all([ee(),C()])}),ge({title:"追蹤紀錄 - 貸款案件管理系統"}),(r,t)=>(g(),m("div",Re,[t[36]||(t[36]=e("div",{class:"flex items-center justify-between"},[e("div",null,[e("h1",{class:"text-3xl font-bold text-gray-900"},"追蹤紀錄"),e("p",{class:"text-gray-600 mt-2"},"顯示所有客戶追蹤紀錄與業務管理記錄")])],-1)),D(fe,{title:"追蹤紀錄列表",columns:s(Z),data:s(F),loading:s(L),error:s(I),"search-query":s(h),"search-placeholder":"搜尋客戶姓名/記錄人員/對話紀錄...","show-search-icon":!1,"current-page":s(M),"items-per-page":s(A),"loading-text":"載入中...","empty-text":"沒有追蹤記錄",onSearch:te,onRefresh:C,onRetry:C,onPageChange:oe,onPageSizeChange:se},{filters:c(()=>[s(V).hasPermission&&s(V).hasPermission("customer_management")?d((g(),m("select",{key:0,"onUpdate:modelValue":t[0]||(t[0]=o=>be(_)?_.value=o:null),class:"px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500"},[t[10]||(t[10]=e("option",{value:"all"},"全部記錄人員",-1)),(g(!0),m(J,null,K(s(S),o=>(g(),m("option",{key:o.id,value:o.id},a(o.name),9,Ce))),128))],512)),[[O,s(_)]]):$("",!0)]),actions:c(()=>[e("button",{onClick:re,class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"},[D(s(he),{class:"-ml-1 mr-2 h-5 w-5","aria-hidden":"true"}),t[11]||(t[11]=y(" 新增追蹤紀錄 ",-1))])]),"cell-customer_name":c(({item:o})=>[e("div",De,a(o.customer_name||"-"),1)]),"cell-tracking_person":c(({item:o})=>[e("div",Ue,a(o.tracking_person_name||"-"),1)]),"cell-contact_time":c(({item:o})=>[e("div",Te,a(G(o.contact_time)),1),e("div",Ve,a(Q(o.contact_time)),1)]),"cell-service_stage":c(({item:o})=>[e("span",je,a(o.service_stage||"-"),1)]),"cell-opportunity_order":c(({item:o})=>[e("span",Le,a(o.opportunity_order||"-"),1)]),"cell-maintenance_progress":c(({item:o})=>[e("span",Pe,a(o.maintenance_progress||"-"),1)]),"cell-opportunity_status":c(({item:o})=>[e("span",Me,a(o.opportunity_status||"-"),1)]),"cell-contact_method":c(({item:o})=>[e("span",$e,a(o.contact_method||"-"),1)]),"cell-conversation_record":c(({item:o})=>[e("span",qe,a(o.conversation_record||"-"),1)]),"cell-actions":c(({item:o})=>[e("div",Ie,[e("button",{onClick:x=>ie(o),class:"group relative inline-flex items-center justify-center p-2 text-blue-600 hover:text-white hover:bg-blue-600 rounded-lg transition-all duration-200",title:"查看詳情"},[D(s(ke),{class:"w-4 h-4"}),t[12]||(t[12]=e("div",{class:"absolute bottom-full mb-2 hidden group-hover:block px-2 py-1 text-xs text-white bg-gray-900 rounded whitespace-nowrap z-10"}," 查看詳情 ",-1))],8,Ne),e("button",{onClick:x=>ae(o),class:"group relative inline-flex items-center justify-center p-2 text-gray-600 hover:text-white hover:bg-gray-600 rounded-lg transition-all duration-200",title:"編輯"},[D(s(xe),{class:"w-4 h-4"}),t[13]||(t[13]=e("div",{class:"absolute bottom-full mb-2 hidden group-hover:block px-2 py-1 text-xs text-white bg-gray-900 rounded whitespace-nowrap z-10"}," 編輯 ",-1))],8,ze),e("button",{onClick:x=>le(o),class:"group relative inline-flex items-center justify-center p-2 text-red-600 hover:text-white hover:bg-red-600 rounded-lg transition-all duration-200",title:"刪除"},[D(s(we),{class:"w-4 h-4"}),t[14]||(t[14]=e("div",{class:"absolute bottom-full mb-2 hidden group-hover:block px-2 py-1 text-xs text-white bg-gray-900 rounded whitespace-nowrap z-10"}," 刪除 ",-1))],8,Ae)])]),_:1},8,["columns","data","loading","error","search-query","current-page","items-per-page"]),s(R)?(g(),m("div",{key:0,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 mt-0",onClick:E(H,["self"])},[e("div",Be,[e("h3",Ee,a(s(f)?"編輯追蹤紀錄":"新增追蹤紀錄"),1),e("form",{onSubmit:E(ne,["prevent"]),class:"space-y-4"},[e("div",null,[t[15]||(t[15]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},[y("客戶姓名 "),e("span",{class:"text-red-500"},"*")],-1)),d(e("input",{"onUpdate:modelValue":t[1]||(t[1]=o=>s(n).customer_name=o),type:"text",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[v,s(n).customer_name]])]),e("div",null,[t[17]||(t[17]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},[y("記錄人員 "),e("span",{class:"text-red-500"},"*")],-1)),d(e("select",{"onUpdate:modelValue":t[2]||(t[2]=o=>s(n).tracking_person_id=o),required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},[t[16]||(t[16]=e("option",{value:""},"請選擇",-1)),(g(!0),m(J,null,K(s(S),o=>(g(),m("option",{key:o.id,value:o.id},a(o.name),9,Oe))),128))],512),[[O,s(n).tracking_person_id]])]),e("div",null,[t[18]||(t[18]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},[y("聯繫時間 "),e("span",{class:"text-red-500"},"*")],-1)),d(e("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>s(n).contact_time=o),type:"datetime-local",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[v,s(n).contact_time]])]),e("div",null,[t[19]||(t[19]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},[y("服務階段 "),e("span",{class:"text-red-500"},"*")],-1)),d(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>s(n).service_stage=o),type:"text",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[v,s(n).service_stage]])]),e("div",null,[t[20]||(t[20]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},"商機單",-1)),d(e("input",{"onUpdate:modelValue":t[5]||(t[5]=o=>s(n).opportunity_order=o),type:"text",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[v,s(n).opportunity_order]])]),e("div",null,[t[21]||(t[21]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},"維護進度",-1)),d(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=o=>s(n).maintenance_progress=o),rows:"3",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[v,s(n).maintenance_progress]])]),e("div",null,[t[22]||(t[22]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},[y("商機狀態 "),e("span",{class:"text-red-500"},"*")],-1)),d(e("input",{"onUpdate:modelValue":t[7]||(t[7]=o=>s(n).opportunity_status=o),type:"text",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[v,s(n).opportunity_status]])]),e("div",null,[t[24]||(t[24]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},[y("聯絡方式 "),e("span",{class:"text-red-500"},"*")],-1)),d(e("select",{"onUpdate:modelValue":t[8]||(t[8]=o=>s(n).contact_method=o),required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},[...t[23]||(t[23]=[pe('<option value="" data-v-3208e805>請選擇</option><option value="電話" data-v-3208e805>電話</option><option value="LINE" data-v-3208e805>LINE</option><option value="面談" data-v-3208e805>面談</option><option value="郵件" data-v-3208e805>郵件</option><option value="系統紀錄" data-v-3208e805>系統紀錄</option><option value="其他" data-v-3208e805>其他</option>',7)])],512),[[O,s(n).contact_method]])]),e("div",null,[t[25]||(t[25]=e("label",{class:"block text-sm font-semibold text-gray-900 mb-1"},"對話紀錄",-1)),d(e("textarea",{"onUpdate:modelValue":t[9]||(t[9]=o=>s(n).conversation_record=o),rows:"5",class:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,512),[[v,s(n).conversation_record]])]),e("div",Fe,[e("button",{type:"button",class:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",onClick:H},"取消"),e("button",{type:"submit",class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:s(P)},a(s(P)?"儲存中...":"儲存"),9,He)])],32)])])):$("",!0),s(z)?(g(),m("div",{key:1,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 mt-0",onClick:E(W,["self"])},[e("div",We,[e("div",{class:"flex justify-between items-center mb-4"},[t[26]||(t[26]=e("h3",{class:"text-lg font-semibold text-gray-900"},"追蹤紀錄詳情",-1)),e("button",{onClick:W,class:"text-gray-400 hover:text-gray-600"},"✕")]),s(l)?(g(),m("div",Ge,[e("div",null,[t[27]||(t[27]=e("label",{class:"block text-sm font-medium text-gray-700"},"客戶姓名",-1)),e("p",Qe,a(s(l).customer_name||"-"),1)]),e("div",null,[t[28]||(t[28]=e("label",{class:"block text-sm font-medium text-gray-700"},"記錄人員",-1)),e("p",Je,a(s(l).tracking_person_name||"-"),1)]),e("div",null,[t[29]||(t[29]=e("label",{class:"block text-sm font-medium text-gray-700"},"聯繫時間",-1)),e("p",Ke,a(G(s(l).contact_time))+" "+a(Q(s(l).contact_time)),1)]),e("div",null,[t[30]||(t[30]=e("label",{class:"block text-sm font-medium text-gray-700"},"服務階段",-1)),e("p",Xe,a(s(l).service_stage||"-"),1)]),e("div",null,[t[31]||(t[31]=e("label",{class:"block text-sm font-medium text-gray-700"},"商機單",-1)),e("p",Ye,a(s(l).opportunity_order||"-"),1)]),e("div",null,[t[32]||(t[32]=e("label",{class:"block text-sm font-medium text-gray-700"},"維護進度",-1)),e("p",Ze,a(s(l).maintenance_progress||"-"),1)]),e("div",null,[t[33]||(t[33]=e("label",{class:"block text-sm font-medium text-gray-700"},"商機狀態",-1)),e("p",et,a(s(l).opportunity_status||"-"),1)]),e("div",null,[t[34]||(t[34]=e("label",{class:"block text-sm font-medium text-gray-700"},"聯絡方式",-1)),e("p",tt,a(s(l).contact_method||"-"),1)]),e("div",null,[t[35]||(t[35]=e("label",{class:"block text-sm font-medium text-gray-700"},"對話紀錄",-1)),e("p",ot,a(s(l).conversation_record||"-"),1)])])):$("",!0)])])):$("",!0)]))}},bt=ue(st,[["__scopeId","data-v-3208e805"]]);export{bt as default};
