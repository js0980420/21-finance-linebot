import oe from"./DgBX7xd1.js";import ae from"./D3cojo9C.js";import ie from"./dEC6R0bn.js";import le from"./Dc4_b61V.js";import re from"./BqPyo1yH.js";import ce from"./DENf3TO5.js";import{_ as de,r as p,b as j,i as _e,u as ue,c as d,a as t,e as a,k as r,d as n,x as w,t as l,N as R,F as Q,q as ge,l as pe,J as me,o as c,j as g,E as fe}from"#entry";import{a as he}from"./DgLT0ASK.js";import{u as ye}from"./Csg14XMH.js";import"./mD2okE1y.js";import"./CI5qNQA5.js";import"./C1TBPVO2.js";import"./0es6LyBp.js";import"./BJ2ClxiI.js";import"./Cd8xZgT4.js";import"./CHOj1P8S.js";import"./Xhxc7jYu.js";import"./-Op9ZE8F.js";import"./BOaBxjYN.js";import"./BlreP_uz.js";import"./BwtY8fMv.js";const be=()=>{const{get:C,post:I}=he();return{getSettings:async()=>await C("/line-integration/settings"),updateSettings:async u=>await I("/line-integration/settings",u),testConnection:async()=>await I("/line-integration/test-connection"),getBotInfo:async()=>await C("/line-integration/bot-info"),getStats:async()=>await C("/line-integration/stats"),getRecentConversations:async(u=10)=>await C("/line-integration/recent-conversations",{limit:u}),sendMessage:async(u,v)=>await I("/line-integration/send-message",{line_user_id:u,message:v})}},ve={class:"space-y-6"},xe={class:"flex items-center justify-between"},ke={class:"flex items-center space-x-3"},we={key:0,class:"flex justify-center items-center py-12"},Ce={key:1,class:"grid grid-cols-1 lg:grid-cols-2 gap-6"},Ie={class:"lg:col-span-2"},Se={class:"bg-white rounded-lg shadow-sm p-6"},je={class:"flex items-center justify-between mb-6"},Be={class:"flex items-center gap-3"},Le={key:0,class:"text-xs text-gray-500"},Ne={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},Ve={class:"relative"},Ue={class:"flex items-center mt-1 text-xs text-green-600"},Te={class:"relative"},Ee={class:"flex items-center mt-1 text-xs text-green-600"},De={class:"flex items-center mt-1 text-xs text-green-600"},Fe={class:"flex items-center justify-between mt-1"},Me={class:"text-xs text-amber-600"},Re={class:"bg-white rounded-lg shadow-sm p-6"},ze={class:"space-y-4"},Ae={key:0,class:"flex justify-center py-8"},$e={key:1,class:"space-y-3"},We={class:"flex justify-between items-center py-2 border-b border-gray-100"},qe={class:"font-semibold text-gray-900"},Oe={class:"flex justify-between items-center py-2 border-b border-gray-100"},Ge={class:"font-semibold text-gray-900"},He={class:"flex justify-between items-center py-2 border-b border-gray-100"},Je={class:"font-semibold text-red-600"},Ke={class:"flex justify-between items-center py-2 border-b border-gray-100"},Pe={class:"font-semibold text-blue-600"},Qe={class:"flex justify-between items-center py-2 border-b border-gray-100"},Xe={class:"font-semibold text-green-600"},Ye={class:"flex justify-between items-center py-2 border-b border-gray-100"},Ze={class:"font-semibold text-purple-600"},et={class:"flex justify-between items-center py-2"},tt={class:"font-semibold text-indigo-600"},st={class:"mt-4"},nt={class:"bg-white rounded-lg shadow-sm p-6"},ot={class:"space-y-4"},at={key:0,class:"flex justify-center py-8"},it={key:1,class:"space-y-3"},lt={class:"flex justify-between items-center py-2 border-b border-gray-100"},rt={class:"font-semibold text-gray-900"},ct={class:"flex justify-between items-center py-2 border-b border-gray-100"},dt={class:"font-mono text-sm text-gray-900"},_t={class:"flex justify-between items-center py-2"},ut={key:2,class:"text-center py-8"},gt={class:"mt-4"},pt={class:"bg-white rounded-lg shadow-sm p-6"},mt={key:0,class:"flex justify-center py-8"},ft={key:1,class:"space-y-3"},ht={class:"flex items-center space-x-3"},yt={class:"w-10 h-10 rounded-full bg-green-100 flex items-center justify-center"},bt={class:"font-medium text-gray-900"},vt={class:"text-sm text-gray-500 truncate max-w-xs"},xt={class:"text-right"},kt={class:"text-sm text-gray-500"},wt={key:2,class:"text-center py-8"},Ct={class:"mt-4"},It={__name:"line",setup(C){const{getSettings:I,updateSettings:z,testConnection:A,getBotInfo:$,getStats:W,getRecentConversations:q}=be(),m=ye(),B=p(!0),u=p(!1),v=p(!1),S=p(!1),L=p(!1),N=p(!1),E=p(null),i=p(null),y=p(null),V=p(null),U=p([]),o=p({channel_access_token:"",channel_secret:"",bot_basic_id:""}),O=j(()=>`${pe().public.apiBaseUrl||""}/line/webhook`),D=j(()=>E.value&&E.value.integration_status||"not_configured"),X=j(()=>({configured:"已設定",partial:"部分設定",not_configured:"未設定"})[D.value]||"未知"),Y=j(()=>({configured:"green",partial:"yellow",not_configured:"red"})[D.value]||"gray"),G=j(()=>{if(!o.value)return!1;const s=o.value.channel_access_token||"",e=o.value.channel_secret||"",f=o.value.bot_basic_id||"",b=s.trim().length>0,x=e.trim().length>0,k=f.trim().length>0;return b||x||k}),H=async()=>{B.value=!0;try{const s=await I();s.data&&(E.value=s.data.settings,i.value={channel_access_token:s.data.settings.channel_access_token||"",channel_secret:s.data.settings.channel_secret||"",bot_basic_id:s.data.settings.bot_basic_id||""},o.value={channel_access_token:"",channel_secret:"",bot_basic_id:""})}catch(s){m.add({title:"載入設定失敗",description:s.message,color:"red"})}finally{B.value=!1}},Z=async()=>{u.value=!0;try{const s={};if(o.value.channel_access_token&&o.value.channel_access_token.trim()&&(s.channel_access_token=o.value.channel_access_token.trim()),o.value.channel_secret&&o.value.channel_secret.trim()&&(s.channel_secret=o.value.channel_secret.trim()),o.value.bot_basic_id&&o.value.bot_basic_id.trim()&&(s.bot_basic_id=o.value.bot_basic_id.trim()),Object.keys(s).length===0){m.add({title:"沒有變更",description:"請輸入要更新的設定值",color:"yellow"});return}const e=await z(s);e.data&&(m.add({title:"設定已儲存",description:e.data.message,color:"green"}),await H(),o.value={channel_access_token:"",channel_secret:"",bot_basic_id:""})}catch(s){m.add({title:"儲存設定失敗",description:s.message,color:"red"})}finally{u.value=!1}},ee=async()=>{v.value=!0;try{const s=await A();if(s.data){const{status:e,message:f}=s.data;m.add({title:e==="success"?"連線測試成功":"連線測試失敗",description:f,color:e==="success"?"green":"red"})}}catch(s){m.add({title:"連線測試失敗",description:s.message,color:"red"})}finally{v.value=!1}},F=async()=>{S.value=!0;try{const s=await W();s.data&&(y.value=s.data.stats)}catch(s){console.error("Failed to load stats:",s)}finally{S.value=!1}},J=async()=>{L.value=!0;try{const s=await $();s.data&&s.data.status==="success"&&(V.value=s.data.bot_info)}catch(s){console.error("Failed to load bot info:",s)}finally{L.value=!1}},M=async()=>{N.value=!0;try{const s=await q(5);s.data&&(U.value=s.data.conversations)}catch(s){console.error("Failed to load recent conversations:",s)}finally{N.value=!1}},te=async()=>{try{await navigator.clipboard.writeText(O.value),m.add({title:"已複製網址",description:"Webhook URL 已複製到剪貼簿",color:"green"})}catch{m.add({title:"複製失敗",description:"無法複製網址到剪貼簿",color:"red"})}},se=s=>s?new Date(s).toLocaleString("zh-TW"):"未知",K=s=>{const e=s==="access_token"?"channel_access_token":"channel_secret",f=i.value?.[e];f&&(o.value[e]=f,m.add({title:"已載入當前設定值",description:"您可以查看或修改當前設定",color:"blue"}))},P=s=>s?s.length<=8?"*".repeat(s.length):s.length>20?s.substring(0,4)+"..."+s.substring(s.length-4):s.substring(0,4)+"*".repeat(s.length-8)+s.substring(s.length-4):"";return _e(async()=>{await H(),i.value?.channel_access_token?(F(),J(),M()):(F(),M())}),ue({title:"LINE 整合 - 貸款案件管理系統"}),(s,e)=>{const f=oe,b=ae,x=me("USpinner"),k=ie,h=le,T=re,ne=ce;return c(),d(Q,null,[t("div",ve,[t("div",xe,[e[6]||(e[6]=t("div",null,[t("h1",{class:"text-3xl font-bold text-gray-900"},"LINE 整合"),t("p",{class:"text-gray-600 mt-2"},"設定 LINE BOT 整合功能，管理聊天室中的 LINE 客戶對話")],-1)),t("div",ke,[a(f,{color:Y.value,variant:D.value==="configured"?"solid":"soft"},{default:r(()=>[g(l(X.value),1)]),_:1},8,["color","variant"]),a(b,{onClick:ee,loading:n(v),disabled:!n(i)?.channel_access_token&&!n(o).channel_access_token,variant:"outline"},{default:r(()=>[...e[5]||(e[5]=[g(" 測試連線 ",-1)])]),_:1},8,["loading","disabled"])])]),n(B)?(c(),d("div",we,[a(x,{size:"lg"})])):(c(),d("div",Ce,[t("div",Ie,[t("div",Se,[t("div",je,[e[8]||(e[8]=t("h2",{class:"text-xl font-semibold text-gray-900"},"基本設定",-1)),t("div",Be,[a(b,{onClick:Z,loading:n(u),disabled:!G.value},{default:r(()=>[...e[7]||(e[7]=[g(" 儲存設定 ",-1)])]),_:1},8,["loading","disabled"]),s.$dev?(c(),d("div",Le," Debug: hasChanges = "+l(G.value),1)):w("",!0)])]),t("div",Ne,[a(T,{label:"Channel Access Token",description:"從 LINE Developers Console 取得的 Channel Access Token",required:""},R({default:r(()=>[t("div",Ve,[a(k,{modelValue:n(o).channel_access_token,"onUpdate:modelValue":e[0]||(e[0]=_=>n(o).channel_access_token=_),type:"text",placeholder:n(i)?.channel_access_token?"輸入新的 Channel Access Token 或留空保持現有設定":"輸入 Channel Access Token",class:"line-input pr-10"},null,8,["modelValue","placeholder"]),n(i)?.channel_access_token&&!n(o).channel_access_token?(c(),d("button",{key:0,type:"button",onClick:e[1]||(e[1]=_=>K("access_token")),class:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",title:"查看當前設定值"},[a(h,{name:"i-heroicons-eye",class:"w-4 h-4"})])):w("",!0)])]),_:2},[n(i)?.channel_access_token&&!n(o).channel_access_token?{name:"help",fn:r(()=>[t("div",Ue,[a(h,{name:"i-heroicons-check-circle",class:"w-3 h-3 mr-1"}),g(" 已儲存 ("+l(P(n(i).channel_access_token))+") ",1)])]),key:"0"}:void 0]),1024),a(T,{label:"Channel Secret",description:"從 LINE Developers Console 取得的 Channel Secret",required:""},R({default:r(()=>[t("div",Te,[a(k,{modelValue:n(o).channel_secret,"onUpdate:modelValue":e[2]||(e[2]=_=>n(o).channel_secret=_),type:"text",placeholder:n(i)?.channel_secret?"輸入新的 Channel Secret 或留空保持現有設定":"輸入 Channel Secret",class:"line-input pr-10"},null,8,["modelValue","placeholder"]),n(i)?.channel_secret&&!n(o).channel_secret?(c(),d("button",{key:0,type:"button",onClick:e[3]||(e[3]=_=>K("channel_secret")),class:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",title:"查看當前設定值"},[a(h,{name:"i-heroicons-eye",class:"w-4 h-4"})])):w("",!0)])]),_:2},[n(i)?.channel_secret&&!n(o).channel_secret?{name:"help",fn:r(()=>[t("div",Ee,[a(h,{name:"i-heroicons-check-circle",class:"w-3 h-3 mr-1"}),g(" 已儲存 ("+l(P(n(i).channel_secret))+") ",1)])]),key:"0"}:void 0]),1024),a(T,{label:"Bot Basic ID",description:"LINE Bot 的 Basic ID（選填）"},R({default:r(()=>[a(k,{modelValue:n(o).bot_basic_id,"onUpdate:modelValue":e[4]||(e[4]=_=>n(o).bot_basic_id=_),placeholder:n(i)?.bot_basic_id?`已設定: ${n(i).bot_basic_id}`:"@xxxxxxxx",class:"line-input"},null,8,["modelValue","placeholder"])]),_:2},[n(i)?.bot_basic_id&&!n(o).bot_basic_id?{name:"help",fn:r(()=>[t("div",De,[a(h,{name:"i-heroicons-check-circle",class:"w-3 h-3 mr-1"}),g(" 已儲存: "+l(n(i).bot_basic_id),1)])]),key:"0"}:void 0]),1024),a(T,{label:"Webhook URL",description:"此網址由系統自動產生，需複製到 LINE Developers Console 設定"},{help:r(()=>[t("div",Fe,[t("div",Me,[a(h,{name:"i-heroicons-information-circle",class:"w-3 h-3 mr-1 inline"}),e[9]||(e[9]=g(" 系統自動產生，不可編輯 ",-1))]),a(b,{onClick:te,variant:"ghost",size:"2xs"},{default:r(()=>[a(h,{name:"i-heroicons-clipboard",class:"w-3 h-3 mr-1"}),e[10]||(e[10]=g(" 複製網址 ",-1))]),_:1})])]),default:r(()=>[a(k,{"model-value":O.value,readonly:"",class:"font-mono text-sm line-input bg-gray-50"},null,8,["model-value"])]),_:1})])])]),t("div",Re,[e[19]||(e[19]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"LINE 整合統計",-1)),t("div",ze,[n(S)?(c(),d("div",Ae,[a(x)])):n(y)?(c(),d("div",$e,[t("div",We,[e[11]||(e[11]=t("span",{class:"text-gray-600"},"總對話數",-1)),t("span",qe,l(n(y).total_conversations),1)]),t("div",Oe,[e[12]||(e[12]=t("span",{class:"text-gray-600"},"總訊息數",-1)),t("span",Ge,l(n(y).total_messages),1)]),t("div",He,[e[13]||(e[13]=t("span",{class:"text-gray-600"},"未讀訊息",-1)),t("span",Je,l(n(y).unread_messages),1)]),t("div",Ke,[e[14]||(e[14]=t("span",{class:"text-gray-600"},"今日訊息",-1)),t("span",Pe,l(n(y).today_messages),1)]),t("div",Qe,[e[15]||(e[15]=t("span",{class:"text-gray-600"},"本週訊息",-1)),t("span",Xe,l(n(y).this_week_messages),1)]),t("div",Ye,[e[16]||(e[16]=t("span",{class:"text-gray-600"},"7日活躍客戶",-1)),t("span",Ze,l(n(y).active_customers_7_days),1)]),t("div",et,[e[17]||(e[17]=t("span",{class:"text-gray-600"},"回覆率",-1)),t("span",tt,l(n(y).response_rate)+"%",1)])])):w("",!0)]),t("div",st,[a(b,{onClick:F,variant:"ghost",size:"sm",block:"",loading:n(S)},{default:r(()=>[...e[18]||(e[18]=[g(" 重新整理統計 ",-1)])]),_:1},8,["loading"])])]),t("div",nt,[e[26]||(e[26]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"LINE Bot 資訊",-1)),t("div",ot,[n(L)?(c(),d("div",at,[a(x)])):n(V)?(c(),d("div",it,[t("div",lt,[e[20]||(e[20]=t("span",{class:"text-gray-600"},"Bot 名稱",-1)),t("span",rt,l(n(V).displayName||"未設定"),1)]),t("div",ct,[e[21]||(e[21]=t("span",{class:"text-gray-600"},"User ID",-1)),t("span",dt,l(n(V).userId||"未知"),1)]),t("div",_t,[e[23]||(e[23]=t("span",{class:"text-gray-600"},"狀態",-1)),a(f,{color:"green",variant:"soft"},{default:r(()=>[...e[22]||(e[22]=[g("正常運作",-1)])]),_:1})])])):!n(i)?.channel_access_token&&!n(o).channel_access_token?(c(),d("div",ut,[...e[24]||(e[24]=[t("p",{class:"text-gray-500"},"請先設定 Channel Access Token",-1)])])):w("",!0)]),t("div",gt,[a(b,{onClick:J,variant:"ghost",size:"sm",block:"",loading:n(L),disabled:!n(i)?.channel_access_token&&!n(o).channel_access_token},{default:r(()=>[...e[25]||(e[25]=[g(" 重新載入 Bot 資訊 ",-1)])]),_:1},8,["loading","disabled"])])])])),t("div",pt,[e[29]||(e[29]=t("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"最近 LINE 對話",-1)),n(N)?(c(),d("div",mt,[a(x)])):n(U)&&n(U).length>0?(c(),d("div",ft,[(c(!0),d(Q,null,ge(n(U),_=>(c(),d("div",{key:_.line_user_id,class:"flex items-center justify-between p-4 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors"},[t("div",ht,[t("div",yt,[a(h,{name:"i-heroicons-user",class:"w-5 h-5 text-green-600"})]),t("div",null,[t("p",bt,l(_.customer?.name||"未知客戶"),1),t("p",vt,l(_.last_message||"無訊息"),1)])]),t("div",xt,[t("p",kt,l(se(_.last_message_time)),1),_.unread_count>0?(c(),fe(f,{key:0,color:"red",variant:"soft",class:"mt-1"},{default:r(()=>[g(l(_.unread_count)+" 未讀 ",1)]),_:2},1024)):w("",!0)])]))),128))])):(c(),d("div",wt,[a(h,{name:"i-heroicons-chat-bubble-left-right",class:"w-12 h-12 text-gray-400 mx-auto mb-2"}),e[27]||(e[27]=t("p",{class:"text-gray-500"},"尚無 LINE 對話記錄",-1))])),t("div",Ct,[a(b,{onClick:M,variant:"ghost",size:"sm",block:"",loading:n(N)},{default:r(()=>[...e[28]||(e[28]=[g(" 重新整理對話列表 ",-1)])]),_:1},8,["loading"])])])]),a(ne)],64)}}},Jt=de(It,[["__scopeId","data-v-5692a2ef"]]);export{Jt as default};
