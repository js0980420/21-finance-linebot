<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”„ Pythonå”ä½œæ•™å­¸å¹³å° - å®Œæ•´è¡çªæª¢æ¸¬ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .card-custom {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .editor-container {
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
        }
        .CodeMirror {
            height: 100%;
            border-radius: 10px;
        }
        
        /* å”ä½œæé†’æ¨£å¼ */
        .collaboration-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideInRight 0.5s ease;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* è¡çªæª¢æ¸¬æ¨¡æ…‹çª—å£ */
        .conflict-modal .modal-content {
            border-radius: 15px;
            border: 3px solid #dc3545;
        }
        .conflict-header {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .conflict-option {
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .conflict-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .option-reload {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }
        .option-force {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: black;
        }
        .option-discuss {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            color: white;
        }
        
        /* ç·¨è¼¯å™¨è¡çªè­¦å‘Š */
        .editor-conflict-warning {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #dc3545;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* åœ¨ç·šç”¨æˆ¶æŒ‡ç¤ºå™¨ */
        .user-indicator {
            display: inline-block;
            padding: 4px 12px;
            background: #28a745;
            color: white;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* èŠå¤©æ¨£å¼ */
        .chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            background: #f8f9fa;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: white;
            border-left: 3px solid #007bff;
        }
        .system-message {
            background: #e9ecef;
            border-left-color: #6c757d;
            font-style: italic;
        }
        .conflict-code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 4px solid #dc3545;
        }
        
        /* AIåŠ©æ•™æ¨£å¼ */
        .ai-analysis {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .ai-suggestion {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        /* æˆåŠŸæç¤º */
        .success-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1060;
            animation: slideInDown 0.5s ease, fadeOut 0.5s ease 4.5s;
        }
        @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-100%); }
            to { transform: translateX(-50%) translateY(0); }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(-50%) translateY(-100%); }
        }
        
        /* æ•™å¸«å»£æ’­æ¨£å¼ */
        .teacher-broadcast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1070;
            max-width: 500px;
            width: 90%;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: zoomIn 0.5s ease;
        }
        @keyframes zoomIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .broadcast-info { background: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; }
        .broadcast-warning { background: #fff3cd; border: 2px solid #ffeaa7; color: #856404; }
        .broadcast-success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .broadcast-error { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <div class="text-center mb-4">
            <h1 class="text-white">
                <i class="fas fa-code-branch"></i> 
                Pythonå”ä½œæ•™å­¸å¹³å°
                <small class="d-block text-white-50 mt-2">å®Œæ•´è¡çªæª¢æ¸¬èˆ‡è§£æ±ºç³»çµ±</small>
            </h1>
        </div>

        <!-- ç™»å…¥å€åŸŸ -->
        <div id="loginSection" class="card-custom p-4 mb-4">
            <h3 class="text-center mb-4">
                <i class="fas fa-users"></i> åŠ å…¥å”ä½œæˆ¿é–“
            </h3>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">æˆ¿é–“åç¨±</label>
                        <input type="text" class="form-control" id="roomInput" placeholder="è¼¸å…¥æˆ¿é–“åç¨±" value="conflict-test">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ‚¨çš„åç¨±</label>
                        <input type="text" class="form-control" id="nameInput" placeholder="è¼¸å…¥æ‚¨çš„åç¨±">
                    </div>
                    <button class="btn btn-primary w-100 mb-3" onclick="joinRoom()">
                        <i class="fas fa-sign-in-alt"></i> åŠ å…¥æˆ¿é–“
                    </button>
                    
                    <!-- æ•™å¸«ç›£æ§æŒ‰éˆ• -->
                    <div class="text-center">
                        <hr class="my-3">
                        <p class="text-muted mb-2">æ•™å¸«å°ˆç”¨</p>
                        <button class="btn btn-outline-warning" onclick="openTeacherDashboard()">
                            <i class="fas fa-chalkboard-teacher"></i> æ•™å¸«ç›£æ§å¾Œå°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å·¥ä½œå€åŸŸ -->
        <div id="workspaceSection" style="display: none;">
            <!-- æˆ¿é–“ä¿¡æ¯ -->
            <div class="card-custom p-3 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h5 class="mb-0">
                            <i class="fas fa-home"></i> 
                            æˆ¿é–“: <span id="currentRoom">-</span>
                        </h5>
                </div>
                    <div class="col-md-4">
                        <div id="onlineUsers">
                            <strong>åœ¨ç·šç”¨æˆ¶:</strong>
                </div>
                </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-success" id="connectionStatus">é€£æ¥ä¸­...</span>
                        <button class="btn btn-outline-danger btn-sm ms-2" onclick="leaveRoom()">
                            é›¢é–‹æˆ¿é–“
                        </button>
            </div>
            </div>
        </div>

            <!-- ç·¨è¼¯å™¨å’ŒèŠå¤©å€åŸŸ -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card-custom p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-code"></i> å”ä½œç·¨è¼¯å™¨</h5>
                            <div>
                                <span class="badge bg-info" id="codeVersion">ç‰ˆæœ¬: 0</span>
                                <button class="btn btn-outline-primary btn-sm ms-2" onclick="saveCode()">
                                    <i class="fas fa-save"></i> æ‰‹å‹•ä¿å­˜
                                </button>
                                </div>
                            </div>
                        <div class="editor-container position-relative" id="editorContainer">
                            <textarea id="codeEditor"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- AIåŠ©æ•™ -->
                    <div class="card-custom p-3 mb-3">
                        <h6><i class="fas fa-robot"></i> AIåŠ©æ•™</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info btn-sm" onclick="askAI('analyze')">
                                åˆ†æç¨‹å¼ç¢¼
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="askAI('check_syntax')">
                                æª¢æŸ¥éŒ¯èª¤
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="askAI('suggest')">
                                æ”¹é€²å»ºè­°
                            </button>
                        </div>
                        <div id="aiResponse" class="mt-3"></div>
                    </div>
                    
                    <!-- èŠå¤©å®¤ -->
                    <div class="card-custom p-3">
                        <h6 style="cursor: pointer;" onclick="focusChatInput()">
                            <i class="fas fa-comments"></i> èŠå¤©è¨è«–
                        </h6>
                        <div class="chat-container" id="chatContainer"></div>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" id="chatInput" 
                                   placeholder="è¼¸å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') sendChat()">
                            <button class="btn btn-primary" onclick="sendChat()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>

    <!-- å”ä½œæé†’ -->
    <div id="collaborationAlert" class="collaboration-alert" style="display: none;">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            <div>
                <strong>âš ï¸ å…¶ä»–åŒå­¸ä¹Ÿåœ¨ä¿®æ”¹ç¨‹å¼ç¢¼ï¼</strong>
                <div class="mt-1">è«‹ç•™æ„æœ€æ–°ç‰ˆæœ¬</div>
                <div class="mt-2">
                    <small>æ­£åœ¨å”ä½œçš„ç”¨æˆ¶:</small>
                    <div id="collaboratingUsers"></div>
                </div>
            </div>
        </div>
                </div>

    <!-- è¡çªè§£æ±ºæ¨¡æ…‹çª—å£ -->
    <div class="modal fade conflict-modal" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header conflict-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        ç¨‹å¼ç¢¼ç‰ˆæœ¬è¡çªæª¢æ¸¬
                    </h5>
                        </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-code-branch"></i>
                        <strong>æª¢æ¸¬åˆ°ç‰ˆæœ¬è¡çªï¼</strong>
                        æ‚¨çš„ç¨‹å¼ç¢¼ç‰ˆæœ¬èˆ‡æœå‹™å™¨ç‰ˆæœ¬ä¸åŒæ­¥ï¼Œè«‹é¸æ“‡è§£æ±ºæ–¹æ¡ˆï¼š
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="conflict-option option-reload" onclick="resolveConflict('reload')">
                                <h6><i class="fas fa-sync-alt"></i> ğŸ”„ é‡æ–°è¼‰å…¥æœ€æ–°ç‰ˆæœ¬</h6>
                                <p class="mb-1">æ”¾æ£„ç•¶å‰ä¿®æ”¹ï¼Œè¼‰å…¥æœå‹™å™¨æœ€æ–°ä»£ç¢¼</p>
                                <small class="text-muted">é©ç”¨æ–¼ç™¼ç¾å…¶ä»–äººçš„ä¿®æ”¹æ›´å¥½çš„æƒ…æ³</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="conflict-option option-force" onclick="resolveConflict('force')">
                                <h6><i class="fas fa-bolt"></i> âš¡ ç¹¼çºŒæˆ‘çš„ç·¨è¼¯ï¼ˆå¼·åˆ¶æ›´æ–°ï¼‰</h6>
                                <p class="mb-1">ç”¨è‡ªå·±çš„ä»£ç¢¼è¦†è“‹æœå‹™å™¨ç‰ˆæœ¬</p>
                                <small class="text-warning">âš ï¸ æ³¨æ„ï¼šæœƒè¦†è“‹å…¶ä»–äººçš„å·¥ä½œï¼Œéœ€è¬¹æ…ä½¿ç”¨</small>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="conflict-option option-discuss" onclick="resolveConflict('discuss')">
                                <h6><i class="fas fa-comments"></i> ğŸ’¬ è¤‡è£½åˆ°èŠå¤©è¨è«–å€</h6>
                                <p class="mb-1">å°‡è¡çªä»£ç¢¼è¤‡è£½åˆ°èŠå¤©å®¤ä¾›å¤§å®¶è¨è«–</p>
                                <small class="text-success">æ¨è–¦æ–¹æ¡ˆï¼šåœ˜éšŠå”å•†è§£æ±ºè¡çª</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="conflict-option option-ai" onclick="askAIForConflictHelp()">
                                <h6><i class="fas fa-robot"></i> ğŸ¤– AIå”åŠ©åˆ†æ</h6>
                                <p class="mb-1">æ™ºèƒ½åˆ†æè¡çªåŸå› å’Œåˆä½µå»ºè­°</p>
                                <small class="text-info">æä¾›å…·é«”çš„ä»£ç¢¼åˆä½µæ–¹æ¡ˆå’Œæœ€ä½³å¯¦è¸</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="conflictAIAnalysis"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€è®Šé‡
        let ws = null;
        let editor = null;
        let currentUser = null;
        let currentRoom = null;
        let codeVersion = 0;
        let conflictData = null;
        let lastAutoSave = 0;
        let isEditing = false;
        let collaboratingUsers = new Set();

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç”Ÿæˆéš¨æ©Ÿç”¨æˆ¶å
            document.getElementById('nameInput').value = `å­¸ç”Ÿ${Math.floor(Math.random() * 1000)}`;
            
            // åˆå§‹åŒ–ç·¨è¼¯å™¨
            initializeEditor();
            
            // è¨­ç½®è‡ªå‹•ä¿å­˜
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN && editor && Date.now() - lastAutoSave > 3000) {
                    saveCode();
                }
            }, 5000);
        });

        // åˆå§‹åŒ–CodeMirrorç·¨è¼¯å™¨
        function initializeEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                indentUnit: 4,
                autoCloseBrackets: true,
                matchBrackets: true,
                extraKeys: {
                    "Ctrl-S": function(cm) {
                        saveCode();
                        return false;
                    }
                }
            });

            // ç›£è½ç·¨è¼¯äº‹ä»¶
            editor.on('changes', function(cm, changes) {
                if (changes.length > 0 && changes[0].origin !== 'setValue') {
                    isEditing = true;
                    lastAutoSave = Date.now();
                    
                    // æª¢æ¸¬å”ä½œ
                    if (collaboratingUsers.size > 0) {
                        showCollaborationAlert();
                    }
                }
            });

            // ç›£è½æ¸¸æ¨™è®ŠåŒ–
            editor.on('cursorActivity', function(cm) {
                if (ws && ws.readyState === WebSocket.OPEN && currentRoom) {
                    const cursor = cm.getCursor();
                    sendMessage({
                        type: 'cursor_change',
                        cursor: cursor
                    });
                }
            });
        }

        // åŠ å…¥æˆ¿é–“
        function joinRoom() {
            const roomName = document.getElementById('roomInput').value.trim();
            const userName = document.getElementById('nameInput').value.trim();
            
            if (!roomName || !userName) {
                alert('è«‹è¼¸å…¥æˆ¿é–“åç¨±å’Œæ‚¨çš„åç¨±');
                return;
            }

            currentUser = userName;
            currentRoom = roomName;
            
            connectWebSocket();
            
            // åˆ‡æ›ç•Œé¢
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('workspaceSection').style.display = 'block';
            document.getElementById('currentRoom').textContent = roomName;
        }

        // é›¢é–‹æˆ¿é–“
        function leaveRoom() {
            if (ws) {
                sendMessage({ type: 'leave_room' });
                ws.close();
            }
            
            // åˆ‡æ›ç•Œé¢
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('workspaceSection').style.display = 'none';
            
            // é‡ç½®ç‹€æ…‹
            currentUser = null;
            currentRoom = null;
            codeVersion = 0;
            collaboratingUsers.clear();
            hideCollaborationAlert();
        }

        // WebSocketé€£æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                document.getElementById('connectionStatus').textContent = 'å·²é€£æ¥';
                document.getElementById('connectionStatus').className = 'badge bg-success';
                
                // åŠ å…¥æˆ¿é–“
                sendMessage({
                    type: 'join_room',
                    roomId: currentRoom,
                    userName: currentUser
                });
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (error) {
                    console.error('è§£ææ¶ˆæ¯å¤±æ•—:', error);
                }
            };

            ws.onclose = function() {
                document.getElementById('connectionStatus').textContent = 'é€£æ¥ä¸­æ–·';
                document.getElementById('connectionStatus').className = 'badge bg-danger';
                
                // å˜—è©¦é‡é€£
                setTimeout(() => {
                    if (currentRoom) {
                        connectWebSocket();
                    }
                }, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocketéŒ¯èª¤:', error);
                document.getElementById('connectionStatus').textContent = 'é€£æ¥éŒ¯èª¤';
                document.getElementById('connectionStatus').className = 'badge bg-warning';
            };
        }

        // ç™¼é€æ¶ˆæ¯
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }

        // è™•ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        function handleMessage(message) {
            switch (message.type) {
                case 'welcome':
                    console.log('æ”¶åˆ°æ­¡è¿æ¶ˆæ¯:', message);
                    break;

                case 'room_joined':
                    codeVersion = message.version;
                    editor.setValue(message.code);
                    updateCodeVersion();
                    updateOnlineUsers(message.users);
                    break;

                case 'user_joined':
                    addChatMessage('ç³»çµ±', `${message.userName} åŠ å…¥äº†æˆ¿é–“`, true);
                    updateOnlineUsers(message.users);
                    break;

                case 'user_left':
                    addChatMessage('ç³»çµ±', `${message.userName} é›¢é–‹äº†æˆ¿é–“`, true);
                    updateOnlineUsers(message.users);
                    collaboratingUsers.delete(message.userName);
                    break;

                case 'code_changed':
                    if (message.userName !== currentUser) {
                        // æª¢æ¸¬è¡çª
                        if (isEditing && message.version > codeVersion) {
                            showConflictModal(message);
                        } else {
                            // æ­£å¸¸æ›´æ–°
                            codeVersion = message.version;
                            editor.setValue(message.code);
                            updateCodeVersion();
                        }
                        
                        // æ¨™è¨˜ç”¨æˆ¶æ­£åœ¨å”ä½œ
                        collaboratingUsers.add(message.userName);
                        setTimeout(() => {
                            collaboratingUsers.delete(message.userName);
                            if (collaboratingUsers.size === 0) {
                                hideCollaborationAlert();
                            }
                        }, 5000);
                    }
                    break;

                case 'code_conflict':
                    showConflictModal(message);
                    break;

                case 'cursor_changed':
                    // é¡¯ç¤ºå…¶ä»–ç”¨æˆ¶çš„æ¸¸æ¨™ä½ç½®
                    console.log(`${message.userName} æ¸¸æ¨™ä½ç½®:`, message.cursor);
                    break;

                case 'chat_message':
                    addChatMessage(message.userName, message.message, false);
                    break;

                case 'chat_history':
                    // è¼‰å…¥èŠå¤©æ­·å²
                    message.messages.forEach(msg => {
                        addChatMessage(msg.userName, msg.message, msg.type === 'system');
                    });
                    break;

                case 'ai_response':
                    displayAIResponse(message.response);
                    break;

                case 'ai_processing':
                    document.getElementById('aiResponse').innerHTML = 
                        '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> AIåˆ†æä¸­...</div>';
                    break;

                case 'teacher_broadcast':
                    showTeacherBroadcast(message);
                    break;

                case 'room_closed':
                    showRoomClosedNotification(message);
                    break;
            }
        }

        // ä¿å­˜ä»£ç¢¼
        function saveCode() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const code = editor.getValue();
            
            sendMessage({
                    type: 'code_change',
                code: code,
                version: codeVersion
            });
            
            isEditing = false;
            lastAutoSave = Date.now();
        }

        // é¡¯ç¤ºè¡çªæ¨¡æ…‹çª—å£
        function showConflictModal(conflictMessage) {
            conflictData = conflictMessage;
            const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
            modal.show();
            
            // é¡¯ç¤ºç·¨è¼¯å™¨è­¦å‘Š
            const warningDiv = document.createElement('div');
            warningDiv.className = 'editor-conflict-warning';
            warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> æª¢æ¸¬åˆ°ç¨‹å¼ç¢¼è¡çªï¼è«‹è§£æ±ºè¡çªå¾Œç¹¼çºŒç·¨è¼¯';
            document.getElementById('editorContainer').appendChild(warningDiv);
        }

        // è§£æ±ºè¡çª
        function resolveConflict(solution) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('conflictModal'));
            
            switch (solution) {
                case 'reload':
                    // é‡æ–°è¼‰å…¥æœ€æ–°ç‰ˆæœ¬
                    codeVersion = conflictData.version;
                    editor.setValue(conflictData.code);
                    updateCodeVersion();
                    addChatMessage('ç³»çµ±', `${currentUser} é¸æ“‡ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬è§£æ±ºè¡çª`, true);
                    showSuccessToast('å·²é‡æ–°è¼‰å…¥æœ€æ–°ç‰ˆæœ¬');
                    break;

                case 'force':
                    // å¼·åˆ¶æ›´æ–°
                    const currentCode = editor.getValue();
                    
                    sendMessage({
                        type: 'code_change',
                        code: currentCode,
                        version: conflictData.version,
                        forceUpdate: true
                    });
                    
                    addChatMessage('ç³»çµ±', `${currentUser} é¸æ“‡å¼·åˆ¶æ›´æ–°è§£æ±ºè¡çª`, true);
                    showSuccessToast('å·²å¼·åˆ¶æ›´æ–°ä»£ç¢¼');
                    break;

                case 'discuss':
                    // è¤‡è£½åˆ°èŠå¤©è¨è«–
                    const myCode = editor.getValue();
                    const conflictMessage = `
=== ç¨‹å¼ç¢¼è¡çªè¨è«– ===
æˆ‘çš„ç‰ˆæœ¬ (${codeVersion}):
${myCode}

æœå‹™å™¨ç‰ˆæœ¬ (${conflictData.version}):
${conflictData.code}

è«‹å¤§å®¶è¨è«–å¦‚ä½•åˆä½µé€™å…©å€‹ç‰ˆæœ¬ã€‚`;
                    
                    sendMessage({
                        type: 'chat_message',
                        message: conflictMessage
                    });
                    
                    showSuccessToast('è¡çªä»£ç¢¼å·²è¤‡è£½åˆ°èŠå¤©å®¤');
                    break;
            }
            
            // æ¸…é™¤è¡çªç‹€æ…‹
            isEditing = false;
            conflictData = null;
            modal.hide();
            
            // ç§»é™¤ç·¨è¼¯å™¨è­¦å‘Š
            const warning = document.querySelector('.editor-conflict-warning');
            if (warning) {
                warning.remove();
            }
        }

        // AIè¡çªå”åŠ©
        function askAIForConflictHelp() {
            if (!conflictData) return;
            
            const analysisDiv = document.getElementById('conflictAIAnalysis');
            analysisDiv.innerHTML = `
                <div class="alert alert-info mt-3">
                    <div class="text-center">
                        <i class="fas fa-robot fa-spin"></i> AIæ­£åœ¨åˆ†æè¡çª...
                    </div>
                </div>`;
            
            // æ¨¡æ“¬AIåˆ†æ
            setTimeout(() => {
                const myCode = editor.getValue();
                const serverCode = conflictData.code;
                
                // ç°¡å–®çš„å·®ç•°åˆ†æ
                const myLines = myCode.split('\n');
                const serverLines = serverCode.split('\n');
                const maxLines = Math.max(myLines.length, serverLines.length);
                let diffCount = 0;
                let firstDiffLine = -1;
                
                for (let i = 0; i < maxLines; i++) {
                    const myLine = myLines[i] || '';
                    const serverLine = serverLines[i] || '';
                    if (myLine !== serverLine) {
                        diffCount++;
                        if (firstDiffLine === -1) firstDiffLine = i + 1;
                    }
                }
                
                const analysis = `
                <div class="ai-analysis alert alert-light border">
                    <h6><i class="fas fa-robot text-primary"></i> ğŸ¤– AIè¡çªåˆ†æçµæœ</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="ai-section">
                                <h6 class="text-info">ğŸ“Š è¡çªåŸå› åˆ†æ:</h6>
                                <ul class="mb-2">
                                    <li>æª¢æ¸¬åˆ° ${diffCount} è¡Œä»£ç¢¼å·®ç•°</li>
                                    <li>é¦–å€‹å·®ç•°å‡ºç¾åœ¨ç¬¬ ${firstDiffLine} è¡Œ</li>
                                    <li>æ‚¨çš„ç‰ˆæœ¬: ${codeVersion}, æœå‹™å™¨ç‰ˆæœ¬: ${conflictData.version}</li>
                                    <li>å¯èƒ½åŸå› : åŒæ™‚ç·¨è¼¯ç›¸åŒå€åŸŸ</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="ai-section">
                                <h6 class="text-success">ğŸ’¡ åˆä½µå»ºè­°:</h6>
                                <ul class="mb-2">
                                    <li>ä¿ç•™å…©å€‹ç‰ˆæœ¬çš„å‡½æ•¸çµæ§‹</li>
                                    <li>å„ªåŒ–è®Šæ•¸å‘½åå’Œè¨»é‡‹</li>
                                    <li>åˆä½µéŒ¯èª¤è™•ç†æ©Ÿåˆ¶</li>
                                    <li>çµ±ä¸€ä»£ç¢¼é¢¨æ ¼</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-section">
                        <h6 class="text-warning">ğŸ¯ æœ€ä½³å¯¦è¸:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>é¿å…æœªä¾†è¡çª:</strong>
                                <ul class="small mb-0">
                                    <li>ä¿®æ”¹å‰åœ¨èŠå¤©å®¤æºé€š</li>
                                    <li>åˆ†å·¥ç·¨è¼¯ä¸åŒå€åŸŸ</li>
                                    <li>å®šæœŸåŒæ­¥ä»£ç¢¼ç‰ˆæœ¬</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <strong>æ¨è–¦è§£æ±ºæ–¹æ¡ˆ:</strong>
                                <ul class="small mb-0">
                                    <li>ä½¿ç”¨"è¤‡è£½åˆ°èŠå¤©è¨è«–"</li>
                                    <li>åœ˜éšŠå”å•†æ±ºå®šä¿ç•™å…§å®¹</li>
                                    <li>æ‰‹å‹•åˆä½µå„ªé»</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <strong>å”ä½œæŠ€å·§:</strong>
                                <ul class="small mb-0">
                                    <li>ä½¿ç”¨è¨»é‡‹æ¨™è¨˜ä¿®æ”¹</li>
                                    <li>å°æ­¥é©Ÿé »ç¹ä¿å­˜</li>
                                    <li>é—œæ³¨å…¶ä»–äººçš„æ¸¸æ¨™ä½ç½®</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-sm me-2" onclick="resolveConflict('discuss')">
                            <i class="fas fa-comments"></i> æ¡ç”¨å»ºè­°ï¼šè¤‡è£½åˆ°èŠå¤©è¨è«–
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('conflictAIAnalysis').innerHTML = ''">
                            <i class="fas fa-times"></i> é—œé–‰åˆ†æ
                        </button>
                    </div>
                </div>`;
                
                analysisDiv.innerHTML = analysis;
            }, 2000);
        }

        // é¡¯ç¤ºå”ä½œæé†’
        function showCollaborationAlert() {
            const alert = document.getElementById('collaborationAlert');
            const usersDiv = document.getElementById('collaboratingUsers');
            
            usersDiv.innerHTML = '';
            collaboratingUsers.forEach(user => {
                const span = document.createElement('span');
                span.className = 'user-indicator';
                span.textContent = user;
                usersDiv.appendChild(span);
            });
            
            alert.style.display = 'block';
            
            // 5ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                if (collaboratingUsers.size === 0) {
                    hideCollaborationAlert();
                }
            }, 5000);
        }

        // éš±è—å”ä½œæé†’
        function hideCollaborationAlert() {
            document.getElementById('collaborationAlert').style.display = 'none';
        }

        // é¡¯ç¤ºæˆåŠŸæç¤º
        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // é¡¯ç¤ºæ•™å¸«å»£æ’­
        function showTeacherBroadcast(message) {
            const broadcast = document.createElement('div');
            broadcast.className = `teacher-broadcast broadcast-${message.messageType}`;
            broadcast.innerHTML = `
                <h5><i class="fas fa-bullhorn"></i> æ•™å¸«é€šçŸ¥</h5>
                <p class="mb-0">${message.message}</p>
            `;
            document.body.appendChild(broadcast);
            
            setTimeout(() => {
                broadcast.remove();
            }, 8000);
        }

        // é¡¯ç¤ºæˆ¿é–“é—œé–‰é€šçŸ¥
        function showRoomClosedNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'teacher-broadcast broadcast-error';
            notification.innerHTML = `
                <h5><i class="fas fa-times-circle"></i> æˆ¿é–“å·²é—œé–‰</h5>
                <p>${message.message}</p>
                <div class="text-center">
                    <div id="countdown">${message.countdown}</div>
                </div>
            `;
            document.body.appendChild(notification);
            
            let countdown = message.countdown;
            const countdownInterval = setInterval(() => {
                countdown--;
                const countdownEl = document.getElementById('countdown');
                if (countdownEl) {
                    countdownEl.textContent = countdown;
                }
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    leaveRoom();
                    notification.remove();
                }
            }, 1000);
        }

        // æ›´æ–°ä»£ç¢¼ç‰ˆæœ¬é¡¯ç¤º
        function updateCodeVersion() {
            document.getElementById('codeVersion').textContent = `ç‰ˆæœ¬: ${codeVersion}`;
        }

        // æ›´æ–°åœ¨ç·šç”¨æˆ¶åˆ—è¡¨
        function updateOnlineUsers(users) {
            const container = document.getElementById('onlineUsers');
            container.innerHTML = '<strong>åœ¨ç·šç”¨æˆ¶:</strong> ';
            
            users.forEach(user => {
                const span = document.createElement('span');
                span.className = 'user-indicator';
                span.textContent = user.userName;
                container.appendChild(span);
            });
        }

        // ç™¼é€èŠå¤©æ¶ˆæ¯
        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            sendMessage({
                type: 'chat_message',
                message: message
            });
            
            input.value = '';
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(userName, message, isSystem = false) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isSystem ? 'system-message' : ''}`;
            
            if (message.includes('=== ç¨‹å¼ç¢¼è¡çªè¨è«– ===')) {
                // è¡çªä»£ç¢¼ç‰¹æ®Šæ ¼å¼
                const parts = message.split('\n');
                let formattedMessage = `<strong>${userName}:</strong><br>`;
                let inCodeBlock = false;
                
                parts.forEach(part => {
                    if (part.includes('æˆ‘çš„ç‰ˆæœ¬') || part.includes('æœå‹™å™¨ç‰ˆæœ¬')) {
                        formattedMessage += `<br><strong>${part}</strong><br>`;
                        inCodeBlock = true;
                    } else if (part.includes('è«‹å¤§å®¶è¨è«–')) {
                        inCodeBlock = false;
                        formattedMessage += `<br><em>${part}</em>`;
                    } else if (inCodeBlock && part.trim()) {
                        formattedMessage += `<div class="conflict-code-block">${part}</div>`;
                    } else if (part.trim()) {
                        formattedMessage += part + '<br>';
                    }
                });
                
                messageDiv.innerHTML = formattedMessage;
            } else {
                messageDiv.innerHTML = `<strong>${userName}:</strong> ${message}`;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // AIåŠ©æ•™åŠŸèƒ½
        function askAI(action) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const code = editor.getValue();
            sendMessage({
                type: 'ai_request',
                action: action,
                data: { code: code },
                requestId: Date.now()
            });
        }

        // é¡¯ç¤ºAIå›æ‡‰
        function displayAIResponse(response) {
            const container = document.getElementById('aiResponse');
            
            if (response.success) {
                let html = '<div class="ai-analysis">';
                html += '<h6><i class="fas fa-robot"></i> AIåŠ©æ•™åˆ†æ</h6>';
                
                if (response.data.score) {
                    html += `<div class="ai-suggestion">ç¨‹å¼ç¢¼å“è³ª: ${response.data.score}/100</div>`;
                }
                
                if (response.data.suggestions) {
                    html += '<div class="ai-suggestion"><strong>å»ºè­°:</strong><ul>';
                    response.data.suggestions.forEach(suggestion => {
                        html += `<li>${suggestion}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-warning">AIæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨</div>';
            }
        }

        // èšç„¦èŠå¤©è¼¸å…¥æ¡†
        function focusChatInput() {
            const input = document.getElementById('chatInput');
            input.focus();
        }

        // æ•™å¸«ç›£æ§è·³è½‰
        function openTeacherDashboard() {
            window.open('/teacher-dashboard.html', '_blank');
        }
    </script>
</body>
</html> 