<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔄 Python協作教學平台 - 完整衝突檢測版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .card-custom {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .editor-container {
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
        }
        .CodeMirror {
            height: 100%;
            border-radius: 10px;
        }
        
        /* 協作提醒樣式 */
        .collaboration-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideInRight 0.5s ease;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* 衝突檢測模態窗口 */
        .conflict-modal .modal-content {
            border-radius: 15px;
            border: 3px solid #dc3545;
        }
        .conflict-header {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .conflict-option {
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .conflict-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .option-reload {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }
        .option-force {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: black;
        }
        .option-discuss {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            color: white;
        }
        
        /* 編輯器衝突警告 */
        .editor-conflict-warning {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #dc3545;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* 在線用戶指示器 */
        .user-indicator {
            display: inline-block;
            padding: 4px 12px;
            background: #28a745;
            color: white;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* 聊天樣式 */
        .chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            background: #f8f9fa;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: white;
            border-left: 3px solid #007bff;
        }
        .system-message {
            background: #e9ecef;
            border-left-color: #6c757d;
            font-style: italic;
        }
        .conflict-code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 4px solid #dc3545;
        }
        
        /* AI助教樣式 */
        .ai-analysis {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .ai-suggestion {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        /* 成功提示 */
        .success-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1060;
            animation: slideInDown 0.5s ease, fadeOut 0.5s ease 4.5s;
        }
        @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-100%); }
            to { transform: translateX(-50%) translateY(0); }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(-50%) translateY(-100%); }
        }
        
        /* 教師廣播樣式 */
        .teacher-broadcast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1070;
            max-width: 500px;
            width: 90%;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: zoomIn 0.5s ease;
        }
        @keyframes zoomIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .broadcast-info { background: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; }
        .broadcast-warning { background: #fff3cd; border: 2px solid #ffeaa7; color: #856404; }
        .broadcast-success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .broadcast-error { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 標題區域 -->
        <div class="text-center mb-4">
            <h1 class="text-white">
                <i class="fas fa-code-branch"></i> 
                Python協作教學平台
                <small class="d-block text-white-50 mt-2">完整衝突檢測與解決系統</small>
            </h1>
        </div>

        <!-- 登入區域 -->
        <div id="loginSection" class="card-custom p-4 mb-4">
            <h3 class="text-center mb-4">
                <i class="fas fa-users"></i> 加入協作房間
            </h3>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">房間名稱</label>
                        <input type="text" class="form-control" id="roomInput" placeholder="輸入房間名稱" value="conflict-test">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">您的名稱</label>
                        <input type="text" class="form-control" id="nameInput" placeholder="輸入您的名稱">
                    </div>
                    <button class="btn btn-primary w-100 mb-3" onclick="joinRoom()">
                        <i class="fas fa-sign-in-alt"></i> 加入房間
                    </button>
                    
                    <!-- 教師監控按鈕 -->
                    <div class="text-center">
                        <hr class="my-3">
                        <p class="text-muted mb-2">教師專用</p>
                        <button class="btn btn-outline-warning" onclick="openTeacherDashboard()">
                            <i class="fas fa-chalkboard-teacher"></i> 教師監控後台
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要工作區域 -->
        <div id="workspaceSection" style="display: none;">
            <!-- 房間信息 -->
            <div class="card-custom p-3 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h5 class="mb-0">
                            <i class="fas fa-home"></i> 
                            房間: <span id="currentRoom">-</span>
                        </h5>
                </div>
                    <div class="col-md-4">
                        <div id="onlineUsers">
                            <strong>在線用戶:</strong>
                </div>
                </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-success" id="connectionStatus">連接中...</span>
                        <button class="btn btn-outline-danger btn-sm ms-2" onclick="leaveRoom()">
                            離開房間
                        </button>
            </div>
            </div>
        </div>

            <!-- 編輯器和聊天區域 -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card-custom p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-code"></i> 協作編輯器</h5>
                            <div>
                                <span class="badge bg-info" id="codeVersion">版本: 0</span>
                                <button class="btn btn-outline-primary btn-sm ms-2" onclick="saveCode()">
                                    <i class="fas fa-save"></i> 手動保存
                                </button>
                                </div>
                            </div>
                        <div class="editor-container position-relative" id="editorContainer">
                            <textarea id="codeEditor"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- AI助教 -->
                    <div class="card-custom p-3 mb-3">
                        <h6><i class="fas fa-robot"></i> AI助教</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info btn-sm" onclick="askAI('analyze')">
                                分析程式碼
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="askAI('check_syntax')">
                                檢查錯誤
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="askAI('suggest')">
                                改進建議
                            </button>
                        </div>
                        <div id="aiResponse" class="mt-3"></div>
                    </div>
                    
                    <!-- 聊天室 -->
                    <div class="card-custom p-3">
                        <h6 style="cursor: pointer;" onclick="focusChatInput()">
                            <i class="fas fa-comments"></i> 聊天討論
                        </h6>
                        <div class="chat-container" id="chatContainer"></div>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" id="chatInput" 
                                   placeholder="輸入消息..." onkeypress="if(event.key==='Enter') sendChat()">
                            <button class="btn btn-primary" onclick="sendChat()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>

    <!-- 協作提醒 -->
    <div id="collaborationAlert" class="collaboration-alert" style="display: none;">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            <div>
                <strong>⚠️ 其他同學也在修改程式碼！</strong>
                <div class="mt-1">請留意最新版本</div>
                <div class="mt-2">
                    <small>正在協作的用戶:</small>
                    <div id="collaboratingUsers"></div>
                </div>
            </div>
        </div>
                </div>

    <!-- 衝突解決模態窗口 -->
    <div class="modal fade conflict-modal" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header conflict-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        程式碼版本衝突檢測
                    </h5>
                        </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-code-branch"></i>
                        <strong>檢測到版本衝突！</strong>
                        您的程式碼版本與服務器版本不同步，請選擇解決方案：
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="conflict-option option-reload" onclick="resolveConflict('reload')">
                                <h6><i class="fas fa-sync-alt"></i> 🔄 重新載入最新版本</h6>
                                <p class="mb-1">放棄當前修改，載入服務器最新代碼</p>
                                <small class="text-muted">適用於發現其他人的修改更好的情況</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="conflict-option option-force" onclick="resolveConflict('force')">
                                <h6><i class="fas fa-bolt"></i> ⚡ 繼續我的編輯（強制更新）</h6>
                                <p class="mb-1">用自己的代碼覆蓋服務器版本</p>
                                <small class="text-warning">⚠️ 注意：會覆蓋其他人的工作，需謹慎使用</small>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="conflict-option option-discuss" onclick="resolveConflict('discuss')">
                                <h6><i class="fas fa-comments"></i> 💬 複製到聊天討論區</h6>
                                <p class="mb-1">將衝突代碼複製到聊天室供大家討論</p>
                                <small class="text-success">推薦方案：團隊協商解決衝突</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="conflict-option option-ai" onclick="askAIForConflictHelp()">
                                <h6><i class="fas fa-robot"></i> 🤖 AI協助分析</h6>
                                <p class="mb-1">智能分析衝突原因和合併建議</p>
                                <small class="text-info">提供具體的代碼合併方案和最佳實踐</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="conflictAIAnalysis"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局變量
        let ws = null;
        let editor = null;
        let currentUser = null;
        let currentRoom = null;
        let codeVersion = 0;
        let conflictData = null;
        let lastAutoSave = 0;
        let isEditing = false;
        let collaboratingUsers = new Set();

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 生成隨機用戶名
            document.getElementById('nameInput').value = `學生${Math.floor(Math.random() * 1000)}`;
            
            // 初始化編輯器
            initializeEditor();
            
            // 設置自動保存
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN && editor && Date.now() - lastAutoSave > 3000) {
                    saveCode();
                }
            }, 5000);
        });

        // 初始化CodeMirror編輯器
        function initializeEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                indentUnit: 4,
                autoCloseBrackets: true,
                matchBrackets: true,
                extraKeys: {
                    "Ctrl-S": function(cm) {
                        saveCode();
                        return false;
                    }
                }
            });

            // 監聽編輯事件
            editor.on('changes', function(cm, changes) {
                if (changes.length > 0 && changes[0].origin !== 'setValue') {
                    isEditing = true;
                    lastAutoSave = Date.now();
                    
                    // 檢測協作
                    if (collaboratingUsers.size > 0) {
                        showCollaborationAlert();
                    }
                }
            });

            // 監聽游標變化
            editor.on('cursorActivity', function(cm) {
                if (ws && ws.readyState === WebSocket.OPEN && currentRoom) {
                    const cursor = cm.getCursor();
                    sendMessage({
                        type: 'cursor_change',
                        cursor: cursor
                    });
                }
            });
        }

        // 加入房間
        function joinRoom() {
            const roomName = document.getElementById('roomInput').value.trim();
            const userName = document.getElementById('nameInput').value.trim();
            
            if (!roomName || !userName) {
                alert('請輸入房間名稱和您的名稱');
                return;
            }

            currentUser = userName;
            currentRoom = roomName;
            
            connectWebSocket();
            
            // 切換界面
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('workspaceSection').style.display = 'block';
            document.getElementById('currentRoom').textContent = roomName;
        }

        // 離開房間
        function leaveRoom() {
            if (ws) {
                sendMessage({ type: 'leave_room' });
                ws.close();
            }
            
            // 切換界面
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('workspaceSection').style.display = 'none';
            
            // 重置狀態
            currentUser = null;
            currentRoom = null;
            codeVersion = 0;
            collaboratingUsers.clear();
            hideCollaborationAlert();
        }

        // WebSocket連接
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                document.getElementById('connectionStatus').textContent = '已連接';
                document.getElementById('connectionStatus').className = 'badge bg-success';
                
                // 加入房間
                sendMessage({
                    type: 'join_room',
                    roomId: currentRoom,
                    userName: currentUser
                });
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (error) {
                    console.error('解析消息失敗:', error);
                }
            };

            ws.onclose = function() {
                document.getElementById('connectionStatus').textContent = '連接中斷';
                document.getElementById('connectionStatus').className = 'badge bg-danger';
                
                // 嘗試重連
                setTimeout(() => {
                    if (currentRoom) {
                        connectWebSocket();
                    }
                }, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocket錯誤:', error);
                document.getElementById('connectionStatus').textContent = '連接錯誤';
                document.getElementById('connectionStatus').className = 'badge bg-warning';
            };
        }

        // 發送消息
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }

        // 處理接收到的消息
        function handleMessage(message) {
            switch (message.type) {
                case 'welcome':
                    console.log('收到歡迎消息:', message);
                    break;

                case 'room_joined':
                    codeVersion = message.version;
                    editor.setValue(message.code);
                    updateCodeVersion();
                    updateOnlineUsers(message.users);
                    break;

                case 'user_joined':
                    addChatMessage('系統', `${message.userName} 加入了房間`, true);
                    updateOnlineUsers(message.users);
                    break;

                case 'user_left':
                    addChatMessage('系統', `${message.userName} 離開了房間`, true);
                    updateOnlineUsers(message.users);
                    collaboratingUsers.delete(message.userName);
                    break;

                case 'code_changed':
                    if (message.userName !== currentUser) {
                        // 檢測衝突
                        if (isEditing && message.version > codeVersion) {
                            showConflictModal(message);
                        } else {
                            // 正常更新
                            codeVersion = message.version;
                            editor.setValue(message.code);
                            updateCodeVersion();
                        }
                        
                        // 標記用戶正在協作
                        collaboratingUsers.add(message.userName);
                        setTimeout(() => {
                            collaboratingUsers.delete(message.userName);
                            if (collaboratingUsers.size === 0) {
                                hideCollaborationAlert();
                            }
                        }, 5000);
                    }
                    break;

                case 'code_conflict':
                    showConflictModal(message);
                    break;

                case 'cursor_changed':
                    // 顯示其他用戶的游標位置
                    console.log(`${message.userName} 游標位置:`, message.cursor);
                    break;

                case 'chat_message':
                    addChatMessage(message.userName, message.message, false);
                    break;

                case 'chat_history':
                    // 載入聊天歷史
                    message.messages.forEach(msg => {
                        addChatMessage(msg.userName, msg.message, msg.type === 'system');
                    });
                    break;

                case 'ai_response':
                    displayAIResponse(message.response);
                    break;

                case 'ai_processing':
                    document.getElementById('aiResponse').innerHTML = 
                        '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> AI分析中...</div>';
                    break;

                case 'teacher_broadcast':
                    showTeacherBroadcast(message);
                    break;

                case 'room_closed':
                    showRoomClosedNotification(message);
                    break;
            }
        }

        // 保存代碼
        function saveCode() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const code = editor.getValue();
            
            sendMessage({
                    type: 'code_change',
                code: code,
                version: codeVersion
            });
            
            isEditing = false;
            lastAutoSave = Date.now();
        }

        // 顯示衝突模態窗口
        function showConflictModal(conflictMessage) {
            conflictData = conflictMessage;
            const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
            modal.show();
            
            // 顯示編輯器警告
            const warningDiv = document.createElement('div');
            warningDiv.className = 'editor-conflict-warning';
            warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 檢測到程式碼衝突！請解決衝突後繼續編輯';
            document.getElementById('editorContainer').appendChild(warningDiv);
        }

        // 解決衝突
        function resolveConflict(solution) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('conflictModal'));
            
            switch (solution) {
                case 'reload':
                    // 重新載入最新版本
                    codeVersion = conflictData.version;
                    editor.setValue(conflictData.code);
                    updateCodeVersion();
                    addChatMessage('系統', `${currentUser} 選擇使用最新版本解決衝突`, true);
                    showSuccessToast('已重新載入最新版本');
                    break;

                case 'force':
                    // 強制更新
                    const currentCode = editor.getValue();
                    
                    sendMessage({
                        type: 'code_change',
                        code: currentCode,
                        version: conflictData.version,
                        forceUpdate: true
                    });
                    
                    addChatMessage('系統', `${currentUser} 選擇強制更新解決衝突`, true);
                    showSuccessToast('已強制更新代碼');
                    break;

                case 'discuss':
                    // 複製到聊天討論
                    const myCode = editor.getValue();
                    const conflictMessage = `
=== 程式碼衝突討論 ===
我的版本 (${codeVersion}):
${myCode}

服務器版本 (${conflictData.version}):
${conflictData.code}

請大家討論如何合併這兩個版本。`;
                    
                    sendMessage({
                        type: 'chat_message',
                        message: conflictMessage
                    });
                    
                    showSuccessToast('衝突代碼已複製到聊天室');
                    break;
            }
            
            // 清除衝突狀態
            isEditing = false;
            conflictData = null;
            modal.hide();
            
            // 移除編輯器警告
            const warning = document.querySelector('.editor-conflict-warning');
            if (warning) {
                warning.remove();
            }
        }

        // AI衝突協助
        function askAIForConflictHelp() {
            if (!conflictData) return;
            
            const analysisDiv = document.getElementById('conflictAIAnalysis');
            analysisDiv.innerHTML = `
                <div class="alert alert-info mt-3">
                    <div class="text-center">
                        <i class="fas fa-robot fa-spin"></i> AI正在分析衝突...
                    </div>
                </div>`;
            
            // 模擬AI分析
            setTimeout(() => {
                const myCode = editor.getValue();
                const serverCode = conflictData.code;
                
                // 簡單的差異分析
                const myLines = myCode.split('\n');
                const serverLines = serverCode.split('\n');
                const maxLines = Math.max(myLines.length, serverLines.length);
                let diffCount = 0;
                let firstDiffLine = -1;
                
                for (let i = 0; i < maxLines; i++) {
                    const myLine = myLines[i] || '';
                    const serverLine = serverLines[i] || '';
                    if (myLine !== serverLine) {
                        diffCount++;
                        if (firstDiffLine === -1) firstDiffLine = i + 1;
                    }
                }
                
                const analysis = `
                <div class="ai-analysis alert alert-light border">
                    <h6><i class="fas fa-robot text-primary"></i> 🤖 AI衝突分析結果</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="ai-section">
                                <h6 class="text-info">📊 衝突原因分析:</h6>
                                <ul class="mb-2">
                                    <li>檢測到 ${diffCount} 行代碼差異</li>
                                    <li>首個差異出現在第 ${firstDiffLine} 行</li>
                                    <li>您的版本: ${codeVersion}, 服務器版本: ${conflictData.version}</li>
                                    <li>可能原因: 同時編輯相同區域</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="ai-section">
                                <h6 class="text-success">💡 合併建議:</h6>
                                <ul class="mb-2">
                                    <li>保留兩個版本的函數結構</li>
                                    <li>優化變數命名和註釋</li>
                                    <li>合併錯誤處理機制</li>
                                    <li>統一代碼風格</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-section">
                        <h6 class="text-warning">🎯 最佳實踐:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>避免未來衝突:</strong>
                                <ul class="small mb-0">
                                    <li>修改前在聊天室溝通</li>
                                    <li>分工編輯不同區域</li>
                                    <li>定期同步代碼版本</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <strong>推薦解決方案:</strong>
                                <ul class="small mb-0">
                                    <li>使用"複製到聊天討論"</li>
                                    <li>團隊協商決定保留內容</li>
                                    <li>手動合併優點</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <strong>協作技巧:</strong>
                                <ul class="small mb-0">
                                    <li>使用註釋標記修改</li>
                                    <li>小步驟頻繁保存</li>
                                    <li>關注其他人的游標位置</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-sm me-2" onclick="resolveConflict('discuss')">
                            <i class="fas fa-comments"></i> 採用建議：複製到聊天討論
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('conflictAIAnalysis').innerHTML = ''">
                            <i class="fas fa-times"></i> 關閉分析
                        </button>
                    </div>
                </div>`;
                
                analysisDiv.innerHTML = analysis;
            }, 2000);
        }

        // 顯示協作提醒
        function showCollaborationAlert() {
            const alert = document.getElementById('collaborationAlert');
            const usersDiv = document.getElementById('collaboratingUsers');
            
            usersDiv.innerHTML = '';
            collaboratingUsers.forEach(user => {
                const span = document.createElement('span');
                span.className = 'user-indicator';
                span.textContent = user;
                usersDiv.appendChild(span);
            });
            
            alert.style.display = 'block';
            
            // 5秒後自動隱藏
            setTimeout(() => {
                if (collaboratingUsers.size === 0) {
                    hideCollaborationAlert();
                }
            }, 5000);
        }

        // 隱藏協作提醒
        function hideCollaborationAlert() {
            document.getElementById('collaborationAlert').style.display = 'none';
        }

        // 顯示成功提示
        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // 顯示教師廣播
        function showTeacherBroadcast(message) {
            const broadcast = document.createElement('div');
            broadcast.className = `teacher-broadcast broadcast-${message.messageType}`;
            broadcast.innerHTML = `
                <h5><i class="fas fa-bullhorn"></i> 教師通知</h5>
                <p class="mb-0">${message.message}</p>
            `;
            document.body.appendChild(broadcast);
            
            setTimeout(() => {
                broadcast.remove();
            }, 8000);
        }

        // 顯示房間關閉通知
        function showRoomClosedNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'teacher-broadcast broadcast-error';
            notification.innerHTML = `
                <h5><i class="fas fa-times-circle"></i> 房間已關閉</h5>
                <p>${message.message}</p>
                <div class="text-center">
                    <div id="countdown">${message.countdown}</div>
                </div>
            `;
            document.body.appendChild(notification);
            
            let countdown = message.countdown;
            const countdownInterval = setInterval(() => {
                countdown--;
                const countdownEl = document.getElementById('countdown');
                if (countdownEl) {
                    countdownEl.textContent = countdown;
                }
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    leaveRoom();
                    notification.remove();
                }
            }, 1000);
        }

        // 更新代碼版本顯示
        function updateCodeVersion() {
            document.getElementById('codeVersion').textContent = `版本: ${codeVersion}`;
        }

        // 更新在線用戶列表
        function updateOnlineUsers(users) {
            const container = document.getElementById('onlineUsers');
            container.innerHTML = '<strong>在線用戶:</strong> ';
            
            users.forEach(user => {
                const span = document.createElement('span');
                span.className = 'user-indicator';
                span.textContent = user.userName;
                container.appendChild(span);
            });
        }

        // 發送聊天消息
        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            sendMessage({
                type: 'chat_message',
                message: message
            });
            
            input.value = '';
        }

        // 添加聊天消息
        function addChatMessage(userName, message, isSystem = false) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isSystem ? 'system-message' : ''}`;
            
            if (message.includes('=== 程式碼衝突討論 ===')) {
                // 衝突代碼特殊格式
                const parts = message.split('\n');
                let formattedMessage = `<strong>${userName}:</strong><br>`;
                let inCodeBlock = false;
                
                parts.forEach(part => {
                    if (part.includes('我的版本') || part.includes('服務器版本')) {
                        formattedMessage += `<br><strong>${part}</strong><br>`;
                        inCodeBlock = true;
                    } else if (part.includes('請大家討論')) {
                        inCodeBlock = false;
                        formattedMessage += `<br><em>${part}</em>`;
                    } else if (inCodeBlock && part.trim()) {
                        formattedMessage += `<div class="conflict-code-block">${part}</div>`;
                    } else if (part.trim()) {
                        formattedMessage += part + '<br>';
                    }
                });
                
                messageDiv.innerHTML = formattedMessage;
            } else {
                messageDiv.innerHTML = `<strong>${userName}:</strong> ${message}`;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // AI助教功能
        function askAI(action) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const code = editor.getValue();
            sendMessage({
                type: 'ai_request',
                action: action,
                data: { code: code },
                requestId: Date.now()
            });
        }

        // 顯示AI回應
        function displayAIResponse(response) {
            const container = document.getElementById('aiResponse');
            
            if (response.success) {
                let html = '<div class="ai-analysis">';
                html += '<h6><i class="fas fa-robot"></i> AI助教分析</h6>';
                
                if (response.data.score) {
                    html += `<div class="ai-suggestion">程式碼品質: ${response.data.score}/100</div>`;
                }
                
                if (response.data.suggestions) {
                    html += '<div class="ai-suggestion"><strong>建議:</strong><ul>';
                    response.data.suggestions.forEach(suggestion => {
                        html += `<li>${suggestion}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-warning">AI服務暫時無法使用</div>';
            }
        }

        // 聚焦聊天輸入框
        function focusChatInput() {
            const input = document.getElementById('chatInput');
            input.focus();
        }

        // 教師監控跳轉
        function openTeacherDashboard() {
            window.open('/teacher-dashboard.html', '_blank');
        }
    </script>
</body>
</html> 