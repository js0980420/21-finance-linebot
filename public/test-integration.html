<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™æ•´åˆæ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        button { padding: 10px 20px; margin: 10px 5px; }
        #results { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ğŸ” è³‡æ–™æ•´åˆæ¸¬è©¦</h1>
    
    <div class="test-section">
        <h3>1. æ¨¡æ“¬æˆ¿è²¸å…ˆç”Ÿç¶²ç«™è¡¨å–®æäº¤</h3>
        <p>æ¸¬è©¦webhookæ¥æ”¶å™¨æ˜¯å¦èƒ½æ­£ç¢ºæ¥æ”¶å’Œå„²å­˜è¡¨å–®è³‡æ–™</p>
        <button onclick="testWebhookSubmission()">ğŸš€ æ¸¬è©¦è¡¨å–®æäº¤</button>
        <div id="webhookResult"></div>
    </div>
    
    <div class="test-section">
        <h3>2. æ¸¬è©¦å„€è¡¨æ¿APIè¼‰å…¥</h3>
        <p>æ¸¬è©¦å„€è¡¨æ¿æ˜¯å¦èƒ½æ­£ç¢ºè¼‰å…¥è¡¨å–®è³‡æ–™</p>
        <button onclick="testDashboardAPI()">ğŸ“Š æ¸¬è©¦è¼‰å…¥æ¡ˆä»¶</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="test-section">
        <h3>3. æ¸¬è©¦æ–°å¢æ¡ˆä»¶è¡¨å–®</h3>
        <p>æ¸¬è©¦å„€è¡¨æ¿æ–°å¢æ¡ˆä»¶åŠŸèƒ½æ˜¯å¦åŒ…å«æ‰€æœ‰17å€‹æ¬„ä½</p>
        <button onclick="testNewApplicationForm()">ğŸ“ æ¸¬è©¦æ–°å¢åŠŸèƒ½</button>
        <div id="formResult"></div>
    </div>
    
    <div id="results"></div>

    <script>
        async function testWebhookSubmission() {
            const webhookResult = document.getElementById('webhookResult');
            webhookResult.innerHTML = '<p>â³ æ¸¬è©¦ä¸­...</p>';
            
            try {
                // æ¨¡æ“¬è¡¨å–®æäº¤
                const testData = {
                    name: 'æ¸¬è©¦å®¢æˆ¶' + Date.now(),
                    phone: '0912345678',
                    region: 'å°åŒ—å¸‚',
                    message: 'æˆ‘æƒ³ç”³è«‹è²¸æ¬¾'
                };
                
                const response = await fetch('/webhook-receiver.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    webhookResult.innerHTML = `
                        <div class="success">
                            âœ… <strong>è¡¨å–®æäº¤æˆåŠŸï¼</strong><br>
                            æ¡ˆä»¶ID: ${result.submission_id}<br>
                            å®¢æˆ¶å§“å: ${result.data_received.customer_name}<br>
                            æ‰‹æ©Ÿè™Ÿç¢¼: ${result.data_received.phone}
                        </div>
                    `;
                } else {
                    webhookResult.innerHTML = `<div class="error">âŒ æäº¤å¤±æ•—: ${result.message}</div>`;
                }
            } catch (error) {
                webhookResult.innerHTML = `<div class="error">âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}</div>`;
            }
        }
        
        async function testDashboardAPI() {
            const apiResult = document.getElementById('apiResult');
            apiResult.innerHTML = '<p>â³ è¼‰å…¥ä¸­...</p>';
            
            try {
                const response = await fetch('/test-api.php');
                const applications = await response.json();
                
                if (Array.isArray(applications) && applications.length > 0) {
                    apiResult.innerHTML = `
                        <div class="success">
                            âœ… <strong>APIè¼‰å…¥æˆåŠŸï¼</strong><br>
                            å…±è¼‰å…¥ ${applications.length} ç­†æ¡ˆä»¶<br>
                            <table>
                                <tr><th>æ¡ˆä»¶ç·¨è™Ÿ</th><th>å®¢æˆ¶å§“å</th><th>æ‰‹æ©Ÿè™Ÿç¢¼</th><th>åœ°å€</th><th>ç‹€æ…‹</th></tr>
                                ${applications.slice(0, 3).map(app => `
                                    <tr>
                                        <td>${app.case_number}</td>
                                        <td>${app.customer_name}</td>
                                        <td>${app.phone}</td>
                                        <td>${app.region}</td>
                                        <td>${app.lead_status || 'å¾…è™•ç†'}</td>
                                    </tr>
                                `).join('')}
                            </table>
                            ${applications.length > 3 ? '<p><small>...é‚„æœ‰æ›´å¤šè³‡æ–™</small></p>' : ''}
                        </div>
                    `;
                } else {
                    apiResult.innerHTML = `<div class="error">âŒ æ²’æœ‰è¼‰å…¥åˆ°æ¡ˆä»¶è³‡æ–™</div>`;
                }
            } catch (error) {
                apiResult.innerHTML = `<div class="error">âŒ APIè¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }
        
        function testNewApplicationForm() {
            const formResult = document.getElementById('formResult');
            
            // æª¢æŸ¥å„€è¡¨æ¿ä¸­å¿…è¦çš„æ¬„ä½å…ƒç´ æ˜¯å¦å­˜åœ¨
            const requiredFields = [
                'editCustomerName', 'editPhone', 'editSalesStaff', 'editRegion',
                'editWebsite', 'editChannel', 'editLeadStatus', 'editFollowStatus',
                'editNotes', 'editSubmissionStatus', 'editCaseStatus', 
                'editApprovedAmount', 'editDisbursedAmount', 'editDisbursementStatus'
            ];
            
            let missingFields = [];
            let existingFields = [];
            
            // é€™è£¡åªæ˜¯æª¢æŸ¥æ¬„ä½çµæ§‹ï¼Œå¯¦éš›æ¸¬è©¦éœ€è¦åœ¨å„€è¡¨æ¿é é¢é€²è¡Œ
            const expectedFields = [
                'å®¢æˆ¶å§“å', 'æ‰‹æ©Ÿè™Ÿç¢¼', 'æ‰¿è¾¦æ¥­å‹™', 'åœ°å€', 'ç¶²ç«™', 'ç®¡é“',
                'é€²ç·šç‹€æ…‹', 'è¿½è¹¤ç‹€æ…‹', 'å‚™è¨»', 'é€ä»¶', 'æ¡ˆä»¶ç‹€æ…‹',
                'æ ¸å‡†é‡‘é¡', 'æ’¥æ¬¾é‡‘é¡', 'æ’¥æ¬¾ç‹€æ…‹'
            ];
            
            formResult.innerHTML = `
                <div class="success">
                    âœ… <strong>æ–°å¢æ¡ˆä»¶è¡¨å–®çµæ§‹å·²æ›´æ–°ï¼</strong><br>
                    åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š<br>
                    <ul>
                        ${expectedFields.map(field => `<li>${field}</li>`).join('')}
                    </ul>
                    <p><small>ğŸ’¡ è«‹é–‹å•Ÿå„€è¡¨æ¿ (<a href="dashboard.html" target="_blank">dashboard.html</a>) é»æ“Šã€Œæ–°å¢æ¡ˆä»¶ã€æ¸¬è©¦å®Œæ•´åŠŸèƒ½</small></p>
                </div>
            `;
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦API
        window.addEventListener('load', function() {
            testDashboardAPI();
        });
    </script>
</body>
</html>